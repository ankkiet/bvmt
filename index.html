<!DOCTYPE html>
<html lang="vi"><!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Green School - A2K41 Official</title>
    
    <meta name="theme-color" content="#2e7d32">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/2e7d32/ffffff.png?text=NVC+Green">
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE STYLES --- */
        :root { --primary: #2e7d32; --primary-dark: #1b5e20; --accent: #ffca28; --danger: #d32f2f; --bg: #f8f9fa; --text: #333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Nunito', sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; }

        /* --- NAVIGATION --- */
        nav.pc-nav { background: linear-gradient(to right, var(--primary), var(--primary-dark)); padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        nav.pc-nav ul { list-style: none; margin: 0; padding: 0; display: flex; justify-content: center; gap: 10px; }
        nav.pc-nav ul li a { color: white; font-weight: 700; text-transform: uppercase; padding: 10px 20px; border-radius: 30px; cursor: pointer; transition: 0.3s; }
        nav.pc-nav ul li a:hover, nav.pc-nav ul li a.active-menu { background: rgba(255,255,255,0.2); color: var(--accent); }
        nav.mobile-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eee; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .mobile-nav-inner { display: flex; height: 65px; justify-content: space-around; align-items: center; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #999; cursor: pointer; }
        .nav-item.active-menu { color: var(--primary); font-weight: 800; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 2px; }

        /* --- LAYOUT --- */
        .container { max-width: 1200px; width: 95%; margin: 25px auto; background: white; padding: 30px; border-radius: 20px; min-height: 80vh; }
        .page-section { display: none; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        h1 { font-family: 'Quicksand', sans-serif; color: var(--primary); text-align: center; border-bottom: 4px solid var(--accent); display: inline-block; position: relative; left: 50%; transform: translateX(-50%); margin-bottom: 30px; }
        .card { background: #fff; border: 1px solid #e0e0e0; border-radius: 16px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn:active { transform: scale(0.98); }
        .btn-danger { background: var(--danger); }
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }

        /* --- GALLERY & ADMIN CONTROLS --- */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .gallery-item { position: relative; border-radius: 12px; overflow: hidden; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: 0.3s; }
        .gallery-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .gallery-img-container { width: 100%; aspect-ratio: 1/1; overflow: hidden; background: #eee; }
        .gallery-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .gallery-item:hover .gallery-img { transform: scale(1.05); }
        .gallery-info { padding: 10px; }
        .gallery-title { font-size: 0.9rem; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* ADMIN POWER BUTTONS */
        .owner-controls { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; z-index: 5; }
        .ctrl-btn { width: 30px; height: 30px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; background: rgba(255,255,255,0.95); box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s; }
        .ctrl-btn:hover { transform: scale(1.1); }
        .ctrl-btn.edit { color: #1976d2; }
        .ctrl-btn.del { color: #d32f2f; }
        
        /* ADMIN TABLE */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        .admin-table th, .admin-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .admin-table th { background: #f5f5f5; color: var(--primary); font-weight: 700; white-space: nowrap; }
        .admin-table td img { vertical-align: middle; }

        /* --- LIGHTBOX (FULL SCREEN & REACTIONS) --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; }
        .lb-container { display: flex; flex-direction: column; height: 100%; width: 100%; max-width: 600px; margin: 0 auto; background: white; position: relative; }
        
        /* IMMERSIVE MODE STYLES */
        .lb-container.immersive .lb-details, 
        .lb-container.immersive .lb-close-btn { display: none !important; }
        .lb-container.immersive .lb-image-area { height: 100vh; background: black; }
        .lb-container.immersive .lb-image-area img { object-fit: contain; }

        .lb-image-area { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; }
        .lb-image-area img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s; }
        .lb-close-btn { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.5); color: white; width: 35px; height: 35px; border-radius: 50%; border: none; cursor: pointer; font-size: 1.2rem; z-index: 100; transition: 0.2s; }
        .lb-close-btn:hover { background: rgba(255,255,255,0.3); }
        
        .lb-details { background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 15px; max-height: 50vh; display: flex; flex-direction: column; transition: 0.3s; }
        .lb-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .lb-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .lb-actions { display: flex; gap: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .lb-action-item { background: none; border: none; cursor: pointer; font-size: 0.9rem; color: #555; display: flex; gap: 5px; align-items: center; transition: 0.2s; }
        .lb-action-item:hover { color: var(--primary); }
        .lb-action-item.liked { color: #e53935; }

        /* REACTIONS REPLACING COMMENTS */
        .lb-reaction-list { flex: 1; overflow-y: auto; margin-bottom: 10px; }
        .lb-reaction-item { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .lb-reaction-bubble { background: #f0f2f5; padding: 6px 12px; border-radius: 15px; font-size: 0.9rem; }
        
        .lb-reaction-presets { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; scrollbar-width: none; }
        .preset-chip { padding: 8px 15px; background: #e8f5e9; color: var(--primary); border: 1px solid var(--primary); border-radius: 20px; font-size: 0.85rem; white-space: nowrap; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .preset-chip:active, .preset-chip:hover { transform: scale(0.95); background: var(--primary); color: white; }

        /* --- EXTRAS --- */
        .ai-fab, .music-fab { position: fixed; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2000; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .ai-fab:hover, .music-fab:hover { transform: scale(1.1); }
        .music-fab { bottom: 85px; right: 15px; background: white; border: 2px solid var(--primary); color: var(--primary); }
        .music-fab.playing { animation: spin 2s linear infinite; border-color: var(--accent); color: var(--accent); }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .ai-fab { bottom: 145px; right: 15px; background: linear-gradient(135deg, #6200ea, #b388ff); color: white; }
        .ai-chat-window { position: fixed; bottom: 200px; right: 15px; width: 300px; height: 400px; background: white; border-radius: 15px; display: none; flex-direction: column; z-index: 2001; box-shadow: 0 5px 20px rgba(0,0,0,0.2); overflow: hidden; animation: zoomIn 0.3s; }
        @keyframes zoomIn { from {opacity: 0; transform: scale(0.8);} to {opacity: 1; transform: scale(1);} }
        
        .ai-body { flex: 1; overflow-y: auto; padding: 10px; background: #f5f5f5; display: flex; flex-direction: column; gap: 8px; }
        .ai-msg { padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; max-width: 80%; line-height: 1.4; word-wrap: break-word; }
        .ai-msg.bot { background: white; border: 1px solid #e0e0e0; border-top-left-radius: 2px; align-self: flex-start; }
        .ai-msg.user { background: #6200ea; color: white; border-top-right-radius: 2px; align-self: flex-end; box-shadow: 0 2px 5px rgba(98, 0, 234, 0.3); }
        .ai-typing { font-style: italic; color: #888; font-size: 0.8rem; margin-left: 5px; display: none; }

        /* LOADING OVERLAY */
        #upload-overlay {
            display: none; position: fixed; top:0; left:0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 10000;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
        }

        @media (min-width: 768px) {
            .container { padding: 40px; }
            nav.pc-nav { display: block; }
            nav.mobile-nav { display: none; }
            .lb-container { max-width: 900px; height: 85vh; border-radius: 10px; flex-direction: row; margin: 40px auto; overflow: hidden; }
            .lb-image-area { width: 65%; }
            .lb-details { width: 35%; max-height: none; margin: 0; border-radius: 0; }
            .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
        }
        @media (max-width: 767px) {
            nav.pc-nav { display: none; }
            nav.mobile-nav { display: block; }
            .container { padding: 20px 15px 100px; margin: 0; width: 100%; border-radius: 0; box-shadow: none; }
        }
    </style>
</head>
<body>

    <!-- OVERLAY B·∫¢O TR√å & UPLOAD -->
    <div id="maintenance-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:99999; flex-direction:column; justify-content:center; align-items:center;">
        <i class="fas fa-tools" style="font-size: 3rem; color: var(--accent); margin-bottom: 20px;"></i>
        <h1>‚ö†Ô∏è H·ªá th·ªëng B·∫£o Tr√¨</h1>
        <p>Vui l√≤ng quay l·∫°i sau √≠t ph√∫t.</p>
        <button class="btn" style="margin-top: 20px;" onclick="checkAdminLogin()">Admin Login</button>
    </div>

    <div id="upload-overlay">
        <div class="spinner"></div>
        <h3 id="upload-loading-text">ƒêang x·ª≠ l√Ω...</h3>
    </div>

    <!-- HIDDEN FILE INPUT -->
    <input type="file" id="file-input" hidden accept="image/*" onchange="executeUpload(this)">

    <!-- AI & MUSIC -->
    <div class="ai-fab" onclick="toggleAIChat()"><i class="fas fa-robot"></i></div>
    <div class="ai-chat-window" id="ai-window">
        <div style="background:#6200ea; color:white; padding:10px 15px; font-weight:bold; display:flex; justify-content:space-between; align-items:center;">
            <span><i class="fas fa-sparkles"></i> Green Bot AI</span> 
            <span onclick="toggleAIChat()" style="cursor:pointer; font-size:1.2rem;">&times;</span>
        </div>
        <div class="ai-body" id="ai-messages">
            <div class="ai-msg bot">Xin ch√†o! T·ªõ l√† tr·ª£ l√Ω ·∫£o c·ªßa l·ªõp A2K41. T·ªõ c√≥ th·ªÉ gi√∫p g√¨ cho c·∫≠u h√¥m nay? üå±</div>
        </div>
        <div id="ai-typing-indicator" class="ai-typing">Bot ƒëang suy nghƒ©...</div>
        <form onsubmit="sendMessageToAI(event)" style="padding:10px; display:flex; gap:5px; background:white; border-top:1px solid #eee;">
            <input id="ai-input" required placeholder="H·ªèi g√¨ ƒë√≥ ƒëi..." autocomplete="off">
            <button type="submit" class="btn btn-sm" style="background:#6200ea;"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>

    <div class="music-fab" onclick="toggleMusic()" id="music-fab"><i class="fas fa-compact-disc" id="music-icon"></i></div>
    <!-- Hidden Audio Player -->
    <audio id="bg-music" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3" type="audio/mpeg">
    </audio>

    <!-- NAV PC -->
    <nav class="pc-nav">
        <ul>
            <li><a onclick="showPage('home')" id="menu-pc-home">Trang Ch·ªß</a></li>
            <li><a onclick="showPage('greenclass')" id="menu-pc-greenclass">G√≥c Xanh</a></li>
            <li><a onclick="showPage('contest')" id="menu-pc-contest">Thi ƒêua</a></li>
            <li><a onclick="showPage('archive')" id="menu-pc-archive">L∆∞u Tr·ªØ</a></li>
            <li><a onclick="showPage('profile')" id="menu-pc-profile">T√†i Kho·∫£n</a></li>
            <li><a onclick="showPage('admin')" id="menu-pc-admin" style="display:none; color:#ff8a80">ADMIN</a></li>
        </ul>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="container">
        
        <!-- HOME SECTION -->
        <div id="home" class="page-section">
            <div style="text-align: center;">
                <div style="position: relative; border-radius: 15px; overflow: hidden; margin-bottom: 20px;">
                    <img src="https://images.pexels.com/photos/1591447/pexels-photo-1591447.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" style="width:100%; display:block;" loading="eager">
                    <div style="position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); padding: 20px; color: white;">
                        <h2 style="margin:0; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">We are Green Generation</h2>
                    </div>
                </div>
                <h1>A2K41 - Green School</h1>
                <!-- N√∫t ƒëƒÉng nh·∫≠p trang ch·ªß -->
                <div id="home-login-area" style="text-align:center; margin-top:20px;">
                    <button class="btn" style="border-radius:50px; padding:15px 40px; font-size:1.2rem;" onclick="handleLogin()">
                        <i class="fas fa-sign-in-alt"></i> ƒêƒÉng Nh·∫≠p V·ªõi Google
                    </button>
                </div>
            </div>
        </div>

        <!-- GREEN CLASS (G√ìC XANH) -->
        <div id="greenclass" class="page-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>üåø G√≥c Xanh</h2>
                <button class="btn" onclick="checkLoginAndUpload('gallery')"><i class="fas fa-camera"></i> ƒêƒÉng ·∫¢nh</button>
            </div>
            <div id="gallery-grid" class="gallery-grid"></div>
        </div>

        <!-- CONTEST (THI ƒêUA) -->
        <div id="contest" class="page-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>üèÜ Thi ƒêua</h2>
                <button class="btn" onclick="checkLoginAndUpload('contest')"><i class="fas fa-upload"></i> B√°o C√°o</button>
            </div>
            <div id="contest-grid" class="gallery-grid"></div>
        </div>

        <!-- ARCHIVE (L∆ØU TR·ªÆ) -->
        <div id="archive" class="page-section">
            <h2>üóÑÔ∏è Kho L∆∞u Tr·ªØ</h2>
            <div class="archive-controls">
                <div class="archive-tab active" onclick="switchArchiveTab('gallery')" id="tab-ar-gallery">G√≥c Xanh</div>
                <div class="archive-tab" onclick="switchArchiveTab('contest')" id="tab-ar-contest">Thi ƒêua</div>
            </div>
            <select id="archive-season-select" onchange="loadArchiveGrid()" style="margin-bottom:15px"><option value="ALL">T·∫•t c·∫£ ƒë·ª£t</option></select>
            <div id="archive-grid" class="gallery-grid"></div>
        </div>

        <!-- PROFILE -->
        <div id="profile" class="page-section">
            <h1>üë§ H·ªì S∆°</h1>
            <div id="profile-out" style="text-align:center; padding:40px;">
                <p>B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.</p>
                <button class="btn" onclick="handleLogin()"><i class="fab fa-google"></i> ƒêƒÉng nh·∫≠p Google</button>
            </div>
            <div id="profile-in" style="display:none;">
                <div class="card" style="text-align:center;">
                    <img id="p-avatar" src="" style="width:100px; height:100px; border-radius:50%; margin-bottom:10px; border: 3px solid var(--primary);">
                    <h3 id="p-name">T√™n User</h3>
                    <p id="p-email" style="color:#666;">email@gmail.com</p>
                    <button class="btn btn-danger" onclick="handleLogout()" style="margin-top:20px;">ƒêƒÉng Xu·∫•t</button>
                </div>
            </div>
        </div>

        <!-- ADMIN PANEL -->
        <div id="admin" class="page-section">
            <h1>üõ† Admin Panel</h1>
            <div class="card">
                <h3>Qu·∫£n l√Ω h·ªá th·ªëng</h3>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: #fafafa; border-radius: 8px;">
                    <input type="checkbox" id="cfg-maintenance" onchange="updateMainConfig()" style="width: 20px; height: 20px; margin: 0; accent-color: var(--primary);"> 
                    <span style="font-weight: bold; margin-left: 10px;">B·∫≠t ch·∫ø ƒë·ªô b·∫£o tr√¨ to√†n trang</span>
                </label>
            </div>
            <div class="card">
                <h3>Danh s√°ch th√†nh vi√™n</h3>
                <p style="font-size: 0.8rem; color: #666;">Hi·ªÉn th·ªã danh s√°ch c√°c th√†nh vi√™n ƒë√£ t·ª´ng ƒëƒÉng nh·∫≠p.</p>
                <div style="overflow-x:auto">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Avatar</th>
                                <th>T√™n</th>
                                <th>Email</th>
                                <th>ƒêƒÉng nh·∫≠p cu·ªëi</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            <tr><td colspan="4" style="text-align:center">B·∫•m 'L√†m m·ªõi' ƒë·ªÉ t·∫£i d·ªØ li·ªáu</td></tr>
                        </tbody>
                    </table>
                </div>
                <button class="btn btn-sm" onclick="loadAdminData()" style="margin-top:15px;"><i class="fas fa-sync"></i> L√†m m·ªõi</button>
            </div>
        </div>

    </div>

    <!-- MOBILE NAV -->
    <nav class="mobile-nav">
        <div class="mobile-nav-inner">
            <a onclick="showPage('home')" id="mob-home" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
            <a onclick="showPage('greenclass')" id="mob-greenclass" class="nav-item"><i class="fas fa-leaf"></i><span>Xanh</span></a>
            <a onclick="showPage('contest')" id="mob-contest" class="nav-item"><i class="fas fa-trophy"></i><span>Thiƒêua</span></a>
            <a onclick="showPage('archive')" id="mob-archive" class="nav-item"><i class="fas fa-box"></i><span>L∆∞u</span></a>
            <a onclick="showPage('profile')" id="mob-profile" class="nav-item"><i class="fas fa-user"></i><span>T√¥i</span></a>
            <a onclick="showPage('admin')" id="mob-admin" class="nav-item" style="display:none; color:red"><i class="fas fa-cogs"></i><span>Admin</span></a>
        </div>
    </nav>

    <!-- LIGHTBOX -->
    <div id="lightbox" class="modal" onclick="if(event.target==this) closeLightbox()">
        <div class="lb-container" id="lb-main-container">
            <button class="lb-close-btn" onclick="closeLightbox()">‚úï</button>
            
            <div class="lb-image-area" onclick="toggleImmersiveMode()">
                <img id="lb-img">
            </div>

            <div class="lb-details">
                <div class="lb-header">
                    <img id="lb-author-avatar" class="lb-avatar">
                    <div style="flex:1">
                        <div id="lb-author-name" style="font-weight:bold;">Name</div>
                        <div id="lb-desc" style="font-size:0.9rem; color:#555;">M√¥ t·∫£ ·∫£nh...</div>
                    </div>
                </div>

                <div class="lb-actions">
                    <button id="lb-like" class="lb-action-item" onclick="handleLike()"><i class="fas fa-heart"></i> <span id="lb-like-count">0</span></button>
                    <button class="lb-action-item" onclick="alert('T√≠nh nƒÉng Download ƒëang b·∫£o tr√¨.')"><i class="fas fa-download"></i></button>
                </div>

                <div class="lb-comments-wrapper" id="lb-cmt-list"></div>

                <div class="lb-reaction-presets">
                    <div class="preset-chip" onclick="postReaction('Tuy·ªát v·ªùi üòç')">Tuy·ªát v·ªùi üòç</div>
                    <div class="preset-chip" onclick="postReaction('C·ªë l√™n nh√© üí™')">C·ªë l√™n nh√© üí™</div>
                    <div class="preset-chip" onclick="postReaction('S√°ng t·∫°o üåü')">S√°ng t·∫°o üåü</div>
                    <div class="preset-chip" onclick="postReaction('ƒê·∫πp l·∫Øm üì∏')">ƒê·∫πp l·∫Øm üì∏</div>
                    <div class="preset-chip" onclick="postReaction('C·∫ßn c·ªë g·∫Øng üõ†Ô∏è')">C·∫ßn c·ªë g·∫Øng üõ†Ô∏è</div>
                    <div class="preset-chip" onclick="postReaction('Xanh s·∫°ch ƒë·∫πp üå±')">Xanh s·∫°ch ƒë·∫πp üå±</div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp, doc, setDoc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. CONFIG & CONSTANTS
        const firebaseConfig = { apiKey: "AIzaSyCJ_XI_fq-yJC909jb9KLIKg3AfGdm6hNs", authDomain: "a2k41nvc-36b0b.firebaseapp.com", projectId: "a2k41nvc-36b0b", storageBucket: "a2k41nvc-36b0b.firebasestorage.app", messagingSenderId: "279516631226", appId: "1:279516631226:web:99012883ed7923ab5c3283" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        const ADMIN_EMAILS = ["kiet0905478167@gmail.com", "anhkiet119209@gmail.com"];
        const CLOUD_NAME = "dekxvneap"; 
        const UPLOAD_PRESET = "a2k41nvc_upload";
        // WARN: API Key l·ªô ·ªü client. Trong th·ª±c t·∫ø n√™n d√πng Proxy.
        const GEMINI_KEY = "AIzaSyAnOwbqmpQcOu_ERINF4nSfEL4ZW95fiGc"; 

        let currentUser = null;
        let currentCollection = 'gallery';
        let currentImgId = null;
        let activeArchiveTab = 'gallery';
        let isMusicPlaying = false;
        let chatHistory = []; // L∆∞u l·ªãch s·ª≠ chat phi√™n hi·ªán t·∫°i

        const isAdmin = (email) => ADMIN_EMAILS.includes(email);

        // --- EXPOSE FUNCTIONS TO GLOBAL SCOPE (CRITICAL FIX) ---
        // V√¨ type="module" t·∫°o scope ri√™ng, HTML onclick kh√¥ng th·∫•y h√†m. Ph·∫£i g√°n v√†o window.
        window.signInWithPopup = signInWithPopup;
        window.auth = auth;
        window.provider = provider;
        window.handleLogout = () => signOut(auth).then(() => location.reload());
        
        // NEW: Wrapper login function to handle auth/unauthorized-domain errors gracefully
        window.handleLogin = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login failed:", error);
                if (error.code === 'auth/unauthorized-domain') {
                    const domain = window.location.hostname;
                    alert(`‚ö†Ô∏è L·ªñI: T√™n mi·ªÅn ch∆∞a ƒë∆∞·ª£c c·∫•p quy·ªÅn (Unauthorized Domain)\n\nFirebase ch·∫∑n ƒëƒÉng nh·∫≠p t·ª´ domain: '${domain}'\n\nC√ÅCH S·ª¨A (D√†nh cho Admin):\n1. V√†o Firebase Console (console.firebase.google.com)\n2. Ch·ªçn project 'a2k41nvc-36b0b'\n3. V√†o Authentication > Settings > Authorized Domains\n4. Th√™m domain: ${domain}`);
                } else if (error.code === 'auth/popup-closed-by-user') {
                    // User closed popup, do nothing
                } else {
                    alert("L·ªói ƒëƒÉng nh·∫≠p: " + error.message);
                }
            }
        };

        // 2. AUTHENTICATION LISTENER
        onAuthStateChanged(auth, async(u) => {
            if (u) {
                currentUser = { uid: u.uid, email: u.email, displayName: u.displayName, photoURL: u.photoURL };
                
                // --- ADMIN: TRACK USER LOGIN ---
                try {
                    const userRef = doc(db, 'users', u.uid);
                    await setDoc(userRef, {
                        email: u.email,
                        displayName: u.displayName,
                        photoURL: u.photoURL,
                        lastLogin: serverTimestamp(),
                        uid: u.uid
                    }, { merge: true });
                } catch(e) { console.error("Error saving user:", e); }
                // ------------------------------

                document.getElementById('profile-in').style.display = 'block';
                document.getElementById('profile-out').style.display = 'none';
                document.getElementById('home-login-area').style.display = 'none';
                document.getElementById('p-avatar').src = u.photoURL;
                document.getElementById('p-name').innerText = u.displayName;
                document.getElementById('p-email').innerText = u.email;
                
                if(isAdmin(u.email)) {
                    document.getElementById('menu-pc-admin').style.display = 'block';
                    document.getElementById('mob-admin').style.display = 'flex';
                }
            } else {
                currentUser = null;
                document.getElementById('profile-in').style.display = 'none';
                document.getElementById('profile-out').style.display = 'block';
                document.getElementById('home-login-area').style.display = 'block';
                document.getElementById('menu-pc-admin').style.display = 'none';
                document.getElementById('mob-admin').style.display = 'none';
            }
            
            // Re-run listener to check maintenance state with new user status
            setupMaintenanceListener();
        });

        // 3. CORE LOGIC: RENDER GRID
        function renderGrid(col, elId) {
            // Realtime update
            onSnapshot(query(collection(db, col), where("archived", "!=", true)), (snap) => {
                const g = document.getElementById(elId);
                g.innerHTML = "";
                const docs = [];
                snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
                // Sort client-side ƒë·ªÉ gi·∫£m index cost, sort by time created
                docs.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));

                if (docs.length === 0) {
                    g.innerHTML = `<div style="text-align:center; grid-column: 1/-1; padding: 20px; color:#999;">Ch∆∞a c√≥ b√†i ƒëƒÉng n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</div>`;
                    return;
                }

                docs.forEach(d => {
                    let ctrls = "";
                    if (currentUser && (currentUser.uid === d.uid || isAdmin(currentUser.email))) {
                        ctrls = `
                        <div class="owner-controls">
                            <button class="ctrl-btn edit" onclick="event.stopPropagation();editPost('${col}','${d.id}','${d.desc}')"><i class="fas fa-pen"></i></button>
                            <button class="ctrl-btn del" onclick="event.stopPropagation();deletePost('${col}','${d.id}')"><i class="fas fa-trash"></i></button>
                        </div>`;
                    }
                    // Th√™m loading="lazy" ƒë·ªÉ t·ªëi ∆∞u
                    g.innerHTML += `
                    <div class="gallery-item" onclick="openLightbox('${col}','${d.id}')">
                        ${ctrls}
                        <div class="gallery-img-container"><img src="${d.url}" class="gallery-img" loading="lazy"></div>
                        <div class="gallery-info">
                            <div class="gallery-title">${d.desc}</div>
                            <div style="font-size:0.8rem; color:#666; display:flex; justify-content:space-between; margin-top:5px;">
                                <span>${d.authorName.split(' ').pop()}</span>
                                <span><i class="fas fa-heart" style="color:${d.likes?.length ? 'red':'#ccc'}"></i> ${d.likes?d.likes.length:0}</span>
                            </div>
                        </div>
                    </div>`;
                });
            });
        }

        renderGrid('gallery', 'gallery-grid');
        renderGrid('contest', 'contest-grid');

        // 4. ARCHIVE LOGIC
        window.loadArchiveGrid = async () => {
            const label = document.getElementById('archive-season-select').value;
            const g = document.getElementById('archive-grid');
            g.innerHTML = '<div style="grid-column:1/-1; text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</div>';
            
            let q;
            if(label === 'ALL') q = query(collection(db, activeArchiveTab), where("archived", "==", true));
            else q = query(collection(db, activeArchiveTab), where("archived", "==", true), where("archiveLabel", "==", label));
            
            try {
                const s = await getDocs(q);
                g.innerHTML = "";
                if(s.empty) {
                    g.innerHTML = '<div style="grid-column:1/-1; text-align:center;">Tr·ªëng.</div>';
                    return;
                }
                s.forEach(d => {
                    const da = d.data();
                    let ctrls = "";
                    if (currentUser && (currentUser.uid === da.uid || isAdmin(currentUser.email))) {
                        ctrls = `
                        <div class="owner-controls">
                            <button class="ctrl-btn edit" onclick="event.stopPropagation();editPost('${activeArchiveTab}','${d.id}','${da.desc}')"><i class="fas fa-pen"></i></button>
                            <button class="ctrl-btn del" onclick="event.stopPropagation();deletePost('${activeArchiveTab}','${d.id}')"><i class="fas fa-trash"></i></button>
                        </div>`;
                    }
                    g.innerHTML += `
                    <div class="gallery-item" onclick="openLightbox('${activeArchiveTab}','${d.id}')">
                        ${ctrls}
                        <div class="gallery-img-container"><img src="${da.url}" class="gallery-img" loading="lazy"></div>
                        <div class="gallery-info"><div class="gallery-title">${da.desc}</div></div>
                    </div>`;
                });
            } catch (error) {
                console.error(error);
                g.innerHTML = "L·ªói t·∫£i d·ªØ li·ªáu l∆∞u tr·ªØ.";
            }
        }

        // 5. LIGHTBOX LOGIC
        window.openLightbox = async (c, i) => {
            currentImgId = i; currentCollection = c;
            document.getElementById('lightbox').style.display = 'block';
            document.getElementById('lb-main-container').classList.remove('immersive'); 
            
            // Set Loading state
            document.getElementById('lb-img').src = "";
            document.getElementById('lb-desc').innerText = "ƒêang t·∫£i...";
            
            try {
                const s = await getDoc(doc(db, c, i));
                if (!s.exists()) { alert("·∫¢nh kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a."); closeLightbox(); return; }
                const d = s.data();
                
                document.getElementById('lb-img').src = d.url;
                document.getElementById('lb-author-avatar').src = d.authorAvatar || 'https://placehold.co/50';
                document.getElementById('lb-author-name').innerText = d.authorName;
                document.getElementById('lb-desc').innerText = d.desc;
                document.getElementById('lb-like-count').innerText = d.likes ? d.likes.length : 0;
                
                const btn = document.getElementById('lb-like');
                if(currentUser && d.likes?.includes(currentUser.uid)) {
                    btn.classList.add('liked'); btn.style.color='red';
                } else {
                    btn.classList.remove('liked'); btn.style.color='#555';
                }

                renderComments(d.comments || []);
            } catch (e) { console.error(e); }
        }

        window.closeLightbox = () => document.getElementById('lightbox').style.display = 'none';
        window.toggleImmersiveMode = () => document.getElementById('lb-main-container').classList.toggle('immersive');

        // 6. INTERACTION (LIKE & REACT)
        window.handleLike = async () => {
            if(!currentUser) return alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·∫£ tim! ‚ù§Ô∏è");
            const ref = doc(db, currentCollection, currentImgId);
            try {
                const s = await getDoc(ref);
                const likes = s.data().likes || [];
                if(likes.includes(currentUser.uid)) {
                    await updateDoc(ref, { likes: arrayRemove(currentUser.uid) });
                    document.getElementById('lb-like').classList.remove('liked');
                    document.getElementById('lb-like').style.color='#555';
                    document.getElementById('lb-like-count').innerText = likes.length - 1;
                } else {
                    await updateDoc(ref, { likes: arrayUnion(currentUser.uid) });
                    document.getElementById('lb-like').classList.add('liked');
                    document.getElementById('lb-like').style.color='red';
                    document.getElementById('lb-like-count').innerText = likes.length + 1;
                }
            } catch(e) { console.error(e); }
        }

        window.postReaction = async (text) => {
            if(!currentUser) return alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ t∆∞∆°ng t√°c! üí¨");
            const ref = doc(db, currentCollection, currentImgId);
            try {
                await updateDoc(ref, {
                    comments: arrayUnion({
                        uid: currentUser.uid,
                        name: currentUser.displayName,
                        avatar: currentUser.photoURL,
                        text: text,
                        time: Date.now()
                    })
                });
                const s = await getDoc(ref);
                renderComments(s.data().comments);
            } catch(e) { console.error(e); }
        }

        function renderComments(arr) {
            const list = document.getElementById('lb-cmt-list');
            list.innerHTML = "";
            if(!arr || arr.length === 0) {
                list.innerHTML = "<div style='text-align:center; color:#999; font-size:0.8rem; margin-top:20px;'>Ch∆∞a c√≥ c·∫£m x√∫c n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</div>";
                return;
            }
            // Show latest first
            [...arr].reverse().forEach(c => {
                list.innerHTML += `
                <div class="lb-reaction-item">
                    <img src="${c.avatar}" style="width:25px; height:25px; border-radius:50%;">
                    <div class="lb-reaction-bubble">
                        <strong>${c.name}</strong>: <span style="color:var(--primary); font-weight:bold;">${c.text}</span>
                    </div>
                </div>`;
            });
        }

        // 7. UPLOAD & AI GEMINI VISION
        window.checkLoginAndUpload = (c) => {
            if(!currentUser) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng b√†i!");
            currentCollection = c;
            // K√≠ch ho·∫°t hidden input
            document.getElementById('file-input').click();
        }

        window.executeUpload = async (input) => {
            const file = input.files[0];
            if(!file) return;
            
            const useAI = confirm("ü§ñ D√πng AI (Gemini 1.5 Flash) ƒë·ªÉ ph√¢n t√≠ch ·∫£nh v√† vi·∫øt caption t·ª± ƒë·ªông kh√¥ng?");
            let desc = "";
            
            document.getElementById('upload-overlay').style.display = 'flex';
            
            try {
                if(useAI) {
                    document.getElementById('upload-loading-text').innerText = "AI ƒëang ph√¢n t√≠ch ·∫£nh...";
                    const b64 = await new Promise((r) => {
                        const reader = new FileReader();
                        reader.onload = () => r(reader.result.split(',')[1]);
                        reader.readAsDataURL(file);
                    });
                    
                    // Prompt t·ªëi ∆∞u cho Gemini 1.5 Flash
                    const prompt = "H√£y ƒë√≥ng vai m·ªôt h·ªçc sinh th√¢n thi·ªán. M√¥ t·∫£ ng·∫Øn g·ªçn b·ª©c ·∫£nh n√†y (d∆∞·ªõi 30 t·ª´), t·∫≠p trung v√†o kh√¥ng kh√≠ vui v·∫ª ho·∫∑c √Ω nghƒ©a m√¥i tr∆∞·ªùng. D√πng ti·∫øng Vi·ªát.";
                    desc = await callGeminiAPI(prompt, b64);
                }
            } catch(e) {
                console.error(e);
                alert("AI ƒëang b·∫≠n, vui l√≤ng nh·∫≠p th·ªß c√¥ng.");
            }
            
            // N·∫øu AI l·ªói ho·∫∑c user kh√¥ng ch·ªçn AI th√¨ h·ªèi th·ªß c√¥ng
            if (!desc) {
                 document.getElementById('upload-overlay').style.display = 'none';
                 // setTimeout ƒë·ªÉ UI render l·∫°i tr∆∞·ªõc khi alert ch·∫∑n thread
                 await new Promise(r => setTimeout(r, 100)); 
                 desc = prompt("Nh·∫≠p m√¥ t·∫£ cho b·ª©c ·∫£nh n√†y:", ""); 
                 if(desc) document.getElementById('upload-overlay').style.display = 'flex';
            }

            if(!desc) { 
                document.getElementById('upload-overlay').style.display='none'; 
                input.value = ""; // Reset input
                return; 
            }

            // Cloudinary Upload
            document.getElementById('upload-loading-text').innerText = "ƒêang t·∫£i ·∫£nh l√™n Cloud...";
            const fd = new FormData();
            fd.append('file', file);
            fd.append('upload_preset', UPLOAD_PRESET);
            
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method:'POST', body:fd });
                const data = await res.json();
                
                if(data.error) throw new Error(data.error.message);

                await addDoc(collection(db, currentCollection), {
                    url: data.secure_url,
                    desc: desc,
                    uid: currentUser.uid,
                    authorName: currentUser.displayName,
                    authorAvatar: currentUser.photoURL,
                    createdAt: serverTimestamp(),
                    likes: [],
                    comments: []
                });
                alert("ƒêƒÉng b√†i th√†nh c√¥ng!");
            } catch(e) {
                alert("L·ªói upload: " + e.message);
            } finally {
                document.getElementById('upload-overlay').style.display = 'none';
                input.value = "";
            }
        }

        // 8. AI CHATBOT (GEMINI 1.5 FLASH REST API)
        window.toggleAIChat = () => {
            const w = document.getElementById('ai-window');
            w.style.display = w.style.display === 'flex' ? 'none' : 'flex';
        }

        window.sendMessageToAI = async (e) => {
            e.preventDefault();
            const input = document.getElementById('ai-input');
            const msg = input.value.trim();
            if(!msg) return;

            const box = document.getElementById('ai-messages');
            box.innerHTML += `<div class="ai-msg user">${msg}</div>`;
            input.value = "";
            box.scrollTop = box.scrollHeight;
            
            document.getElementById('ai-typing-indicator').style.display = 'block';

            // Context Prompt
            const systemPrompt = "B·∫°n l√† Green Bot, tr·ª£ l√Ω ·∫£o c·ªßa l·ªõp A2K41. B·∫°n th√¢n thi·ªán, h√†i h∆∞·ªõc, d√πng nhi·ªÅu emoji. B·∫°n gi√∫p tr·∫£ l·ªùi v·ªÅ b√†i t·∫≠p, l·ªãch h·ªçc ho·∫∑c ƒë∆°n gi·∫£n l√† tr√≤ chuy·ªán vui v·∫ª.";
            
            // X√¢y d·ª±ng history ƒë∆°n gi·∫£n ƒë·ªÉ g·ª≠i k√®m
            const contents = [
                { role: "user", parts: [{ text: systemPrompt + " User v·ª´a n√≥i: " + msg }] }
            ];

            try {
                // Call Gemini 1.5 Flash
                const reply = await callGeminiAPI(msg, null, true); // true = chat mode logic inside callGeminiAPI if needed, but here simple content gen is fine
                
                document.getElementById('ai-typing-indicator').style.display = 'none';
                box.innerHTML += `<div class="ai-msg bot">${parseMarkdown(reply)}</div>`;
                box.scrollTop = box.scrollHeight;
            } catch (err) {
                document.getElementById('ai-typing-indicator').style.display = 'none';
                box.innerHTML += `<div class="ai-msg bot" style="color:red">Bot ƒëang ng·ªß g·∫≠t... (L·ªói k·∫øt n·ªëi)</div>`;
            }
        }

        // Simple Markdown parser for AI bold text
        function parseMarkdown(text) {
            return text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        }

        // GENERIC GEMINI CALLER (Optimized)
        async function callGeminiAPI(text, imageBase64, isChat = false) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`;
            
            const parts = [{ text: text }];
            if (imageBase64) {
                parts.push({ inline_data: { mime_type: "image/jpeg", data: imageBase64 } });
            }

            const body = {
                contents: [{ parts: parts }]
            };
            
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            const data = await res.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text;
        }

        // 9. MUSIC PLAYER LOGIC
        window.toggleMusic = () => {
            const audio = document.getElementById('bg-music');
            const fab = document.getElementById('music-fab');
            
            if (isMusicPlaying) {
                audio.pause();
                fab.classList.remove('playing');
            } else {
                audio.play().catch(e => alert("Tr√¨nh duy·ªát ch·∫∑n t·ª± ph√°t nh·∫°c. H√£y t∆∞∆°ng t√°c v·ªõi trang web tr∆∞·ªõc!"));
                fab.classList.add('playing');
            }
            isMusicPlaying = !isMusicPlaying;
        }

        // 10. ADMIN & UTILS
        window.deletePost = async (c, i) => {
            if(confirm("Admin: X√≥a vƒ©nh vi·ªÖn b√†i n√†y?")) {
                await deleteDoc(doc(db, c, i));
                if(document.getElementById('lightbox').style.display === 'block') closeLightbox();
                if(c === activeArchiveTab) loadArchiveGrid();
            }
        }

        window.editPost = async (c, i, oldDesc) => {
            const newDesc = prompt("Admin Edit:", oldDesc);
            if(newDesc) {
                await updateDoc(doc(db, c, i), { desc: newDesc });
                if(document.getElementById('lightbox').style.display === 'block') {
                    document.getElementById('lb-desc').innerText = newDesc;
                }
                if(c === activeArchiveTab) loadArchiveGrid();
            }
        }

        window.showPage = (id) => {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            sessionStorage.setItem('page', id);
            
            document.querySelectorAll('nav.pc-nav a, .nav-item').forEach(a => a.classList.remove('active-menu'));
            if(document.getElementById('menu-pc-'+id)) document.getElementById('menu-pc-'+id).classList.add('active-menu');
            if(document.getElementById('mob-'+id)) document.getElementById('mob-'+id).classList.add('active-menu');

            if(id === 'archive') { loadArchiveSeasons(); window.loadArchiveGrid(); }
        }
        showPage(sessionStorage.getItem('page') || 'home');

        window.switchArchiveTab = (t) => {
            activeArchiveTab = t;
            document.querySelectorAll('.archive-tab').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-ar-'+t).classList.add('active');
            loadArchiveSeasons();
            loadArchiveGrid();
        }

        window.loadArchiveSeasons = async () => {
            const s = document.getElementById('archive-season-select');
            s.innerHTML = '<option value="ALL">üìÇ T·∫•t c·∫£ ƒë·ª£t</option>';
            // Note: archives_meta collection needs to be managed separately
        }

        window.checkAdminLogin = () => {
            const pwd = prompt("Nh·∫≠p m·∫≠t kh·∫©u Admin:");
            if(pwd === "A2K41VIP") { // Simple password logic
                document.getElementById('maintenance-overlay').style.display = 'none';
            } else {
                alert("Sai m·∫≠t kh·∫©u");
            }
        }

        // --- NEW ADMIN FUNCTIONS ---
        
        // 1. Load User List (Updated)
        window.loadAdminData = async () => {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
            
            try {
                // Fetch all users from Firestore
                const q = query(collection(db, 'users'), orderBy('lastLogin', 'desc'));
                const snap = await getDocs(q);
                
                tbody.innerHTML = "";
                if(snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Ch∆∞a c√≥ th√†nh vi√™n n√†o.</td></tr>';
                    return;
                }

                snap.forEach(d => {
                    const u = d.data();
                    const lastLogin = u.lastLogin ? new Date(u.lastLogin.seconds * 1000).toLocaleString('vi-VN') : 'Kh√¥ng r√µ';
                    tbody.innerHTML += `
                        <tr>
                            <td><img src="${u.photoURL}" style="width:30px; height:30px; border-radius:50%; object-fit:cover"></td>
                            <td>${u.displayName}</td>
                            <td>${u.email}</td>
                            <td>${lastLogin}</td>
                        </tr>
                    `;
                });
            } catch(e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="4" style="color:red; text-align:center">L·ªói: ${e.message} (C√≥ th·ªÉ c·∫ßn t·∫°o Index trong Firebase Console)</td></tr>`;
            }
        }
        
        // 2. Maintenance Config (Realtime & Write)
        let configListener = null;

        function setupMaintenanceListener() {
            if(configListener) configListener(); // Unsubscribe old
            
            // Listen to system config
            configListener = onSnapshot(doc(db, 'system', 'config'), (docSnap) => {
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    const isMaint = data.maintenance === true;
                    
                    // Update UI Checkbox
                    const cb = document.getElementById('cfg-maintenance');
                    if(cb) cb.checked = isMaint;

                    // Logic: Show overlay if Maintenance ON AND User is NOT Admin
                    const isUserAdmin = currentUser && isAdmin(currentUser.email);
                    
                    if (isMaint && !isUserAdmin) {
                         document.getElementById('maintenance-overlay').style.display = 'flex';
                    } else {
                         document.getElementById('maintenance-overlay').style.display = 'none';
                    }
                }
            });
        }
        
        setupMaintenanceListener(); // Run immediately

        window.updateMainConfig = async () => {
            const isChecked = document.getElementById('cfg-maintenance').checked;
            try {
                await setDoc(doc(db, 'system', 'config'), { maintenance: isChecked }, { merge: true });
                alert(isChecked ? "ƒê√£ B·∫¨T ch·∫ø ƒë·ªô b·∫£o tr√¨. Ng∆∞·ªùi d√πng th∆∞·ªùng s·∫Ω kh√¥ng truy c·∫≠p ƒë∆∞·ª£c." : "ƒê√£ T·∫ÆT ch·∫ø ƒë·ªô b·∫£o tr√¨.");
            } catch(e) {
                alert("L·ªói c·∫≠p nh·∫≠t c·∫•u h√¨nh: " + e.message);
                // Revert UI if fail
                document.getElementById('cfg-maintenance').checked = !isChecked;
            }
        }

    </script>
</body>
</html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Green School - A2K41 Official</title>
    
    <meta name="theme-color" content="#2e7d32">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/2e7d32/ffffff.png?text=NVC+Green">
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE STYLES --- */
        :root { --primary: #2e7d32; --primary-dark: #1b5e20; --accent: #ffca28; --danger: #d32f2f; --bg: #f8f9fa; --text: #333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Nunito', sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; }

        /* --- NAVIGATION --- */
        nav.pc-nav { background: linear-gradient(to right, var(--primary), var(--primary-dark)); padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        nav.pc-nav ul { list-style: none; margin: 0; padding: 0; display: flex; justify-content: center; gap: 10px; }
        nav.pc-nav ul li a { color: white; font-weight: 700; text-transform: uppercase; padding: 10px 20px; border-radius: 30px; cursor: pointer; transition: 0.3s; }
        nav.pc-nav ul li a:hover, nav.pc-nav ul li a.active-menu { background: rgba(255,255,255,0.2); color: var(--accent); }
        nav.mobile-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eee; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .mobile-nav-inner { display: flex; height: 65px; justify-content: space-around; align-items: center; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #999; cursor: pointer; }
        .nav-item.active-menu { color: var(--primary); font-weight: 800; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 2px; }

        /* --- LAYOUT --- */
        .container { max-width: 1200px; width: 95%; margin: 25px auto; background: white; padding: 30px; border-radius: 20px; min-height: 80vh; }
        .page-section { display: none; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        h1 { font-family: 'Quicksand', sans-serif; color: var(--primary); text-align: center; border-bottom: 4px solid var(--accent); display: inline-block; position: relative; left: 50%; transform: translateX(-50%); margin-bottom: 30px; }
        .card { background: #fff; border: 1px solid #e0e0e0; border-radius: 16px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn:active { transform: scale(0.98); }
        .btn-danger { background: var(--danger); }
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }

        /* --- GALLERY & ADMIN CONTROLS --- */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .gallery-item { position: relative; border-radius: 12px; overflow: hidden; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: 0.3s; }
        .gallery-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .gallery-img-container { width: 100%; aspect-ratio: 1/1; overflow: hidden; background: #eee; }
        .gallery-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .gallery-item:hover .gallery-img { transform: scale(1.05); }
        .gallery-info { padding: 10px; }
        .gallery-title { font-size: 0.9rem; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* ADMIN POWER BUTTONS */
        .owner-controls { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; z-index: 5; }
        .ctrl-btn { width: 30px; height: 30px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; background: rgba(255,255,255,0.95); box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s; }
        .ctrl-btn:hover { transform: scale(1.1); }
        .ctrl-btn.edit { color: #1976d2; }
        .ctrl-btn.del { color: #d32f2f; }

        /* --- LIGHTBOX (FULL SCREEN & REACTIONS) --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; }
        .lb-container { display: flex; flex-direction: column; height: 100%; width: 100%; max-width: 600px; margin: 0 auto; background: white; position: relative; }
        
        /* IMMERSIVE MODE STYLES */
        .lb-container.immersive .lb-details, 
        .lb-container.immersive .lb-close-btn { display: none !important; }
        .lb-container.immersive .lb-image-area { height: 100vh; background: black; }
        .lb-container.immersive .lb-image-area img { object-fit: contain; }

        .lb-image-area { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; }
        .lb-image-area img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s; }
        .lb-close-btn { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.5); color: white; width: 35px; height: 35px; border-radius: 50%; border: none; cursor: pointer; font-size: 1.2rem; z-index: 100; transition: 0.2s; }
        .lb-close-btn:hover { background: rgba(255,255,255,0.3); }
        
        .lb-details { background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 15px; max-height: 50vh; display: flex; flex-direction: column; transition: 0.3s; }
        .lb-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .lb-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .lb-actions { display: flex; gap: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .lb-action-item { background: none; border: none; cursor: pointer; font-size: 0.9rem; color: #555; display: flex; gap: 5px; align-items: center; transition: 0.2s; }
        .lb-action-item:hover { color: var(--primary); }
        .lb-action-item.liked { color: #e53935; }

        /* REACTIONS REPLACING COMMENTS */
        .lb-reaction-list { flex: 1; overflow-y: auto; margin-bottom: 10px; }
        .lb-reaction-item { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .lb-reaction-bubble { background: #f0f2f5; padding: 6px 12px; border-radius: 15px; font-size: 0.9rem; }
        
        .lb-reaction-presets { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; scrollbar-width: none; }
        .preset-chip { padding: 8px 15px; background: #e8f5e9; color: var(--primary); border: 1px solid var(--primary); border-radius: 20px; font-size: 0.85rem; white-space: nowrap; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .preset-chip:active, .preset-chip:hover { transform: scale(0.95); background: var(--primary); color: white; }

        /* --- EXTRAS --- */
        .ai-fab, .music-fab { position: fixed; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2000; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .ai-fab:hover, .music-fab:hover { transform: scale(1.1); }
        .music-fab { bottom: 85px; right: 15px; background: white; border: 2px solid var(--primary); color: var(--primary); }
        .music-fab.playing { animation: spin 2s linear infinite; border-color: var(--accent); color: var(--accent); }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .ai-fab { bottom: 145px; right: 15px; background: linear-gradient(135deg, #6200ea, #b388ff); color: white; }
        .ai-chat-window { position: fixed; bottom: 200px; right: 15px; width: 300px; height: 400px; background: white; border-radius: 15px; display: none; flex-direction: column; z-index: 2001; box-shadow: 0 5px 20px rgba(0,0,0,0.2); overflow: hidden; animation: zoomIn 0.3s; }
        @keyframes zoomIn { from {opacity: 0; transform: scale(0.8);} to {opacity: 1; transform: scale(1);} }
        
        .ai-body { flex: 1; overflow-y: auto; padding: 10px; background: #f5f5f5; display: flex; flex-direction: column; gap: 8px; }
        .ai-msg { padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; max-width: 80%; line-height: 1.4; word-wrap: break-word; }
        .ai-msg.bot { background: white; border: 1px solid #e0e0e0; border-top-left-radius: 2px; align-self: flex-start; }
        .ai-msg.user { background: #6200ea; color: white; border-top-right-radius: 2px; align-self: flex-end; box-shadow: 0 2px 5px rgba(98, 0, 234, 0.3); }
        .ai-typing { font-style: italic; color: #888; font-size: 0.8rem; margin-left: 5px; display: none; }

        /* LOADING OVERLAY */
        #upload-overlay {
            display: none; position: fixed; top:0; left:0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 10000;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
        }

        @media (min-width: 768px) {
            .container { padding: 40px; }
            nav.pc-nav { display: block; }
            nav.mobile-nav { display: none; }
            .lb-container { max-width: 900px; height: 85vh; border-radius: 10px; flex-direction: row; margin: 40px auto; overflow: hidden; }
            .lb-image-area { width: 65%; }
            .lb-details { width: 35%; max-height: none; margin: 0; border-radius: 0; }
            .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
        }
        @media (max-width: 767px) {
            nav.pc-nav { display: none; }
            nav.mobile-nav { display: block; }
            .container { padding: 20px 15px 100px; margin: 0; width: 100%; border-radius: 0; box-shadow: none; }
        }
    </style>
</head>
<body>

    <!-- OVERLAY B·∫¢O TR√å & UPLOAD -->
    <div id="maintenance-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:99999; flex-direction:column; justify-content:center; align-items:center;">
        <i class="fas fa-tools" style="font-size: 3rem; color: var(--accent); margin-bottom: 20px;"></i>
        <h1>‚ö†Ô∏è H·ªá th·ªëng B·∫£o Tr√¨</h1>
        <p>Vui l√≤ng quay l·∫°i sau √≠t ph√∫t.</p>
        <button class="btn" style="margin-top: 20px;" onclick="checkAdminLogin()">Admin Login</button>
    </div>

    <div id="upload-overlay">
        <div class="spinner"></div>
        <h3 id="upload-loading-text">ƒêang x·ª≠ l√Ω...</h3>
    </div>

    <!-- HIDDEN FILE INPUT -->
    <input type="file" id="file-input" hidden accept="image/*" onchange="executeUpload(this)">

    <!-- AI & MUSIC -->
    <div class="ai-fab" onclick="toggleAIChat()"><i class="fas fa-robot"></i></div>
    <div class="ai-chat-window" id="ai-window">
        <div style="background:#6200ea; color:white; padding:10px 15px; font-weight:bold; display:flex; justify-content:space-between; align-items:center;">
            <span><i class="fas fa-sparkles"></i> Green Bot AI</span> 
            <span onclick="toggleAIChat()" style="cursor:pointer; font-size:1.2rem;">&times;</span>
        </div>
        <div class="ai-body" id="ai-messages">
            <div class="ai-msg bot">Xin ch√†o! T·ªõ l√† tr·ª£ l√Ω ·∫£o c·ªßa l·ªõp A2K41. T·ªõ c√≥ th·ªÉ gi√∫p g√¨ cho c·∫≠u h√¥m nay? üå±</div>
        </div>
        <div id="ai-typing-indicator" class="ai-typing">Bot ƒëang suy nghƒ©...</div>
        <form onsubmit="sendMessageToAI(event)" style="padding:10px; display:flex; gap:5px; background:white; border-top:1px solid #eee;">
            <input id="ai-input" required placeholder="H·ªèi g√¨ ƒë√≥ ƒëi..." autocomplete="off">
            <button type="submit" class="btn btn-sm" style="background:#6200ea;"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>

    <div class="music-fab" onclick="toggleMusic()" id="music-fab"><i class="fas fa-compact-disc" id="music-icon"></i></div>
    <!-- Hidden Audio Player -->
    <audio id="bg-music" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3" type="audio/mpeg">
    </audio>

    <!-- NAV PC -->
    <nav class="pc-nav">
        <ul>
            <li><a onclick="showPage('home')" id="menu-pc-home">Trang Ch·ªß</a></li>
            <li><a onclick="showPage('greenclass')" id="menu-pc-greenclass">G√≥c Xanh</a></li>
            <li><a onclick="showPage('contest')" id="menu-pc-contest">Thi ƒêua</a></li>
            <li><a onclick="showPage('archive')" id="menu-pc-archive">L∆∞u Tr·ªØ</a></li>
            <li><a onclick="showPage('profile')" id="menu-pc-profile">T√†i Kho·∫£n</a></li>
            <li><a onclick="showPage('admin')" id="menu-pc-admin" style="display:none; color:#ff8a80">ADMIN</a></li>
        </ul>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="container">
        
        <!-- HOME SECTION -->
        <div id="home" class="page-section">
            <div style="text-align: center;">
                <div style="position: relative; border-radius: 15px; overflow: hidden; margin-bottom: 20px;">
                    <img src="https://images.pexels.com/photos/1591447/pexels-photo-1591447.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" style="width:100%; display:block;" loading="eager">
                    <div style="position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); padding: 20px; color: white;">
                        <h2 style="margin:0; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">We are Green Generation</h2>
                    </div>
                </div>
                <h1>A2K41 - Green School</h1>
                <!-- N√∫t ƒëƒÉng nh·∫≠p trang ch·ªß -->
                <div id="home-login-area" style="text-align:center; margin-top:20px;">
                    <button class="btn" style="border-radius:50px; padding:15px 40px; font-size:1.2rem;" onclick="handleLogin()">
                        <i class="fas fa-sign-in-alt"></i> ƒêƒÉng Nh·∫≠p V·ªõi Google
                    </button>
                </div>
            </div>
        </div>

        <!-- GREEN CLASS (G√ìC XANH) -->
        <div id="greenclass" class="page-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>üåø G√≥c Xanh</h2>
                <button class="btn" onclick="checkLoginAndUpload('gallery')"><i class="fas fa-camera"></i> ƒêƒÉng ·∫¢nh</button>
            </div>
            <div id="gallery-grid" class="gallery-grid"></div>
        </div>

        <!-- CONTEST (THI ƒêUA) -->
        <div id="contest" class="page-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>üèÜ Thi ƒêua</h2>
                <button class="btn" onclick="checkLoginAndUpload('contest')"><i class="fas fa-upload"></i> B√°o C√°o</button>
            </div>
            <div id="contest-grid" class="gallery-grid"></div>
        </div>

        <!-- ARCHIVE (L∆ØU TR·ªÆ) -->
        <div id="archive" class="page-section">
            <h2>üóÑÔ∏è Kho L∆∞u Tr·ªØ</h2>
            <div class="archive-controls">
                <div class="archive-tab active" onclick="switchArchiveTab('gallery')" id="tab-ar-gallery">G√≥c Xanh</div>
                <div class="archive-tab" onclick="switchArchiveTab('contest')" id="tab-ar-contest">Thi ƒêua</div>
            </div>
            <select id="archive-season-select" onchange="loadArchiveGrid()" style="margin-bottom:15px"><option value="ALL">T·∫•t c·∫£ ƒë·ª£t</option></select>
            <div id="archive-grid" class="gallery-grid"></div>
        </div>

        <!-- PROFILE -->
        <div id="profile" class="page-section">
            <h1>üë§ H·ªì S∆°</h1>
            <div id="profile-out" style="text-align:center; padding:40px;">
                <p>B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.</p>
                <button class="btn" onclick="handleLogin()"><i class="fab fa-google"></i> ƒêƒÉng nh·∫≠p Google</button>
            </div>
            <div id="profile-in" style="display:none;">
                <div class="card" style="text-align:center;">
                    <img id="p-avatar" src="" style="width:100px; height:100px; border-radius:50%; margin-bottom:10px; border: 3px solid var(--primary);">
                    <h3 id="p-name">T√™n User</h3>
                    <p id="p-email" style="color:#666;">email@gmail.com</p>
                    <button class="btn btn-danger" onclick="handleLogout()" style="margin-top:20px;">ƒêƒÉng Xu·∫•t</button>
                </div>
            </div>
        </div>

        <!-- ADMIN PANEL -->
        <div id="admin" class="page-section">
            <h1>üõ† Admin Panel</h1>
            <div class="card">
                <h3>Qu·∫£n l√Ω h·ªá th·ªëng</h3>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="cfg-maintenance" onchange="updateMainConfig()" style="width: auto; margin: 0;"> 
                    B·∫≠t ch·∫ø ƒë·ªô b·∫£o tr√¨ to√†n trang
                </label>
            </div>
            <div class="card">
                <h3>Danh s√°ch th√†nh vi√™n</h3>
                <p style="font-size: 0.8rem; color: #666;">Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t...</p>
                <div style="overflow-x:auto"><table class="admin-table"><tbody id="user-table-body"></tbody></table></div>
                <button class="btn btn-sm" onclick="loadAdminData()">L√†m m·ªõi</button>
            </div>
        </div>

    </div>

    <!-- MOBILE NAV -->
    <nav class="mobile-nav">
        <div class="mobile-nav-inner">
            <a onclick="showPage('home')" id="mob-home" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
            <a onclick="showPage('greenclass')" id="mob-greenclass" class="nav-item"><i class="fas fa-leaf"></i><span>Xanh</span></a>
            <a onclick="showPage('contest')" id="mob-contest" class="nav-item"><i class="fas fa-trophy"></i><span>Thiƒêua</span></a>
            <a onclick="showPage('archive')" id="mob-archive" class="nav-item"><i class="fas fa-box"></i><span>L∆∞u</span></a>
            <a onclick="showPage('profile')" id="mob-profile" class="nav-item"><i class="fas fa-user"></i><span>T√¥i</span></a>
            <a onclick="showPage('admin')" id="mob-admin" class="nav-item" style="display:none; color:red"><i class="fas fa-cogs"></i><span>Admin</span></a>
        </div>
    </nav>

    <!-- LIGHTBOX -->
    <div id="lightbox" class="modal" onclick="if(event.target==this) closeLightbox()">
        <div class="lb-container" id="lb-main-container">
            <button class="lb-close-btn" onclick="closeLightbox()">‚úï</button>
            
            <div class="lb-image-area" onclick="toggleImmersiveMode()">
                <img id="lb-img">
            </div>

            <div class="lb-details">
                <div class="lb-header">
                    <img id="lb-author-avatar" class="lb-avatar">
                    <div style="flex:1">
                        <div id="lb-author-name" style="font-weight:bold;">Name</div>
                        <div id="lb-desc" style="font-size:0.9rem; color:#555;">M√¥ t·∫£ ·∫£nh...</div>
                    </div>
                </div>

                <div class="lb-actions">
                    <button id="lb-like" class="lb-action-item" onclick="handleLike()"><i class="fas fa-heart"></i> <span id="lb-like-count">0</span></button>
                    <button class="lb-action-item" onclick="alert('T√≠nh nƒÉng Download ƒëang b·∫£o tr√¨.')"><i class="fas fa-download"></i></button>
                </div>

                <div class="lb-comments-wrapper" id="lb-cmt-list"></div>

                <div class="lb-reaction-presets">
                    <div class="preset-chip" onclick="postReaction('Tuy·ªát v·ªùi üòç')">Tuy·ªát v·ªùi üòç</div>
                    <div class="preset-chip" onclick="postReaction('C·ªë l√™n nh√© üí™')">C·ªë l√™n nh√© üí™</div>
                    <div class="preset-chip" onclick="postReaction('S√°ng t·∫°o üåü')">S√°ng t·∫°o üåü</div>
                    <div class="preset-chip" onclick="postReaction('ƒê·∫πp l·∫Øm üì∏')">ƒê·∫πp l·∫Øm üì∏</div>
                    <div class="preset-chip" onclick="postReaction('C·∫ßn c·ªë g·∫Øng üõ†Ô∏è')">C·∫ßn c·ªë g·∫Øng üõ†Ô∏è</div>
                    <div class="preset-chip" onclick="postReaction('Xanh s·∫°ch ƒë·∫πp üå±')">Xanh s·∫°ch ƒë·∫πp üå±</div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp, doc, setDoc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. CONFIG & CONSTANTS
        const firebaseConfig = { apiKey: "AIzaSyCJ_XI_fq-yJC909jb9KLIKg3AfGdm6hNs", authDomain: "a2k41nvc-36b0b.firebaseapp.com", projectId: "a2k41nvc-36b0b", storageBucket: "a2k41nvc-36b0b.firebasestorage.app", messagingSenderId: "279516631226", appId: "1:279516631226:web:99012883ed7923ab5c3283" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        const ADMIN_EMAILS = ["kiet0905478167@gmail.com", "anhkiet119209@gmail.com"];
        const CLOUD_NAME = "dekxvneap"; 
        const UPLOAD_PRESET = "a2k41nvc_upload";
        // WARN: API Key l·ªô ·ªü client. Trong th·ª±c t·∫ø n√™n d√πng Proxy.
        const GEMINI_KEY = "AIzaSyAnOwbqmpQcOu_ERINF4nSfEL4ZW95fiGc"; 

        let currentUser = null;
        let currentCollection = 'gallery';
        let currentImgId = null;
        let activeArchiveTab = 'gallery';
        let isMusicPlaying = false;
        let chatHistory = []; // L∆∞u l·ªãch s·ª≠ chat phi√™n hi·ªán t·∫°i

        const isAdmin = (email) => ADMIN_EMAILS.includes(email);

        // --- EXPOSE FUNCTIONS TO GLOBAL SCOPE (CRITICAL FIX) ---
        // V√¨ type="module" t·∫°o scope ri√™ng, HTML onclick kh√¥ng th·∫•y h√†m. Ph·∫£i g√°n v√†o window.
        window.signInWithPopup = signInWithPopup;
        window.auth = auth;
        window.provider = provider;
        window.handleLogout = () => signOut(auth).then(() => location.reload());
        
        // NEW: Wrapper login function to handle auth/unauthorized-domain errors gracefully
        window.handleLogin = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login failed:", error);
                if (error.code === 'auth/unauthorized-domain') {
                    const domain = window.location.hostname;
                    alert(`‚ö†Ô∏è L·ªñI: T√™n mi·ªÅn ch∆∞a ƒë∆∞·ª£c c·∫•p quy·ªÅn (Unauthorized Domain)\n\nFirebase ch·∫∑n ƒëƒÉng nh·∫≠p t·ª´ domain: '${domain}'\n\nC√ÅCH S·ª¨A (D√†nh cho Admin):\n1. V√†o Firebase Console (console.firebase.google.com)\n2. Ch·ªçn project 'a2k41nvc-36b0b'\n3. V√†o Authentication > Settings > Authorized Domains\n4. Th√™m domain: ${domain}`);
                } else if (error.code === 'auth/popup-closed-by-user') {
                    // User closed popup, do nothing
                } else {
                    alert("L·ªói ƒëƒÉng nh·∫≠p: " + error.message);
                }
            }
        };

        // 2. AUTHENTICATION LISTENER
        onAuthStateChanged(auth, async(u) => {
            if (u) {
                currentUser = { uid: u.uid, email: u.email, displayName: u.displayName, photoURL: u.photoURL };
                document.getElementById('profile-in').style.display = 'block';
                document.getElementById('profile-out').style.display = 'none';
                document.getElementById('home-login-area').style.display = 'none';
                document.getElementById('p-avatar').src = u.photoURL;
                document.getElementById('p-name').innerText = u.displayName;
                document.getElementById('p-email').innerText = u.email;
                if(isAdmin(u.email)) {
                    document.getElementById('menu-pc-admin').style.display = 'block';
                    document.getElementById('mob-admin').style.display = 'flex';
                }
            } else {
                currentUser = null;
                document.getElementById('profile-in').style.display = 'none';
                document.getElementById('profile-out').style.display = 'block';
                document.getElementById('home-login-area').style.display = 'block';
                document.getElementById('menu-pc-admin').style.display = 'none';
                document.getElementById('mob-admin').style.display = 'none';
            }
        });

        // 3. CORE LOGIC: RENDER GRID
        function renderGrid(col, elId) {
            // Realtime update
            onSnapshot(query(collection(db, col), where("archived", "!=", true)), (snap) => {
                const g = document.getElementById(elId);
                g.innerHTML = "";
                const docs = [];
                snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
                // Sort client-side ƒë·ªÉ gi·∫£m index cost, sort by time created
                docs.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));

                if (docs.length === 0) {
                    g.innerHTML = `<div style="text-align:center; grid-column: 1/-1; padding: 20px; color:#999;">Ch∆∞a c√≥ b√†i ƒëƒÉng n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</div>`;
                    return;
                }

                docs.forEach(d => {
                    let ctrls = "";
                    if (currentUser && (currentUser.uid === d.uid || isAdmin(currentUser.email))) {
                        ctrls = `
                        <div class="owner-controls">
                            <button class="ctrl-btn edit" onclick="event.stopPropagation();editPost('${col}','${d.id}','${d.desc}')"><i class="fas fa-pen"></i></button>
                            <button class="ctrl-btn del" onclick="event.stopPropagation();deletePost('${col}','${d.id}')"><i class="fas fa-trash"></i></button>
                        </div>`;
                    }
                    // Th√™m loading="lazy" ƒë·ªÉ t·ªëi ∆∞u
                    g.innerHTML += `
                    <div class="gallery-item" onclick="openLightbox('${col}','${d.id}')">
                        ${ctrls}
                        <div class="gallery-img-container"><img src="${d.url}" class="gallery-img" loading="lazy"></div>
                        <div class="gallery-info">
                            <div class="gallery-title">${d.desc}</div>
                            <div style="font-size:0.8rem; color:#666; display:flex; justify-content:space-between; margin-top:5px;">
                                <span>${d.authorName.split(' ').pop()}</span>
                                <span><i class="fas fa-heart" style="color:${d.likes?.length ? 'red':'#ccc'}"></i> ${d.likes?d.likes.length:0}</span>
                            </div>
                        </div>
                    </div>`;
                });
            });
        }

        renderGrid('gallery', 'gallery-grid');
        renderGrid('contest', 'contest-grid');

        // 4. ARCHIVE LOGIC
        window.loadArchiveGrid = async () => {
            const label = document.getElementById('archive-season-select').value;
            const g = document.getElementById('archive-grid');
            g.innerHTML = '<div style="grid-column:1/-1; text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</div>';
            
            let q;
            if(label === 'ALL') q = query(collection(db, activeArchiveTab), where("archived", "==", true));
            else q = query(collection(db, activeArchiveTab), where("archived", "==", true), where("archiveLabel", "==", label));
            
            try {
                const s = await getDocs(q);
                g.innerHTML = "";
                if(s.empty) {
                    g.innerHTML = '<div style="grid-column:1/-1; text-align:center;">Tr·ªëng.</div>';
                    return;
                }
                s.forEach(d => {
                    const da = d.data();
                    let ctrls = "";
                    if (currentUser && (currentUser.uid === da.uid || isAdmin(currentUser.email))) {
                        ctrls = `
                        <div class="owner-controls">
                            <button class="ctrl-btn edit" onclick="event.stopPropagation();editPost('${activeArchiveTab}','${d.id}','${da.desc}')"><i class="fas fa-pen"></i></button>
                            <button class="ctrl-btn del" onclick="event.stopPropagation();deletePost('${activeArchiveTab}','${d.id}')"><i class="fas fa-trash"></i></button>
                        </div>`;
                    }
                    g.innerHTML += `
                    <div class="gallery-item" onclick="openLightbox('${activeArchiveTab}','${d.id}')">
                        ${ctrls}
                        <div class="gallery-img-container"><img src="${da.url}" class="gallery-img" loading="lazy"></div>
                        <div class="gallery-info"><div class="gallery-title">${da.desc}</div></div>
                    </div>`;
                });
            } catch (error) {
                console.error(error);
                g.innerHTML = "L·ªói t·∫£i d·ªØ li·ªáu l∆∞u tr·ªØ.";
            }
        }

        // 5. LIGHTBOX LOGIC
        window.openLightbox = async (c, i) => {
            currentImgId = i; currentCollection = c;
            document.getElementById('lightbox').style.display = 'block';
            document.getElementById('lb-main-container').classList.remove('immersive'); 
            
            // Set Loading state
            document.getElementById('lb-img').src = "";
            document.getElementById('lb-desc').innerText = "ƒêang t·∫£i...";
            
            try {
                const s = await getDoc(doc(db, c, i));
                if (!s.exists()) { alert("·∫¢nh kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a."); closeLightbox(); return; }
                const d = s.data();
                
                document.getElementById('lb-img').src = d.url;
                document.getElementById('lb-author-avatar').src = d.authorAvatar || 'https://placehold.co/50';
                document.getElementById('lb-author-name').innerText = d.authorName;
                document.getElementById('lb-desc').innerText = d.desc;
                document.getElementById('lb-like-count').innerText = d.likes ? d.likes.length : 0;
                
                const btn = document.getElementById('lb-like');
                if(currentUser && d.likes?.includes(currentUser.uid)) {
                    btn.classList.add('liked'); btn.style.color='red';
                } else {
                    btn.classList.remove('liked'); btn.style.color='#555';
                }

                renderComments(d.comments || []);
            } catch (e) { console.error(e); }
        }

        window.closeLightbox = () => document.getElementById('lightbox').style.display = 'none';
        window.toggleImmersiveMode = () => document.getElementById('lb-main-container').classList.toggle('immersive');

        // 6. INTERACTION (LIKE & REACT)
        window.handleLike = async () => {
            if(!currentUser) return alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·∫£ tim! ‚ù§Ô∏è");
            const ref = doc(db, currentCollection, currentImgId);
            try {
                const s = await getDoc(ref);
                const likes = s.data().likes || [];
                if(likes.includes(currentUser.uid)) {
                    await updateDoc(ref, { likes: arrayRemove(currentUser.uid) });
                    document.getElementById('lb-like').classList.remove('liked');
                    document.getElementById('lb-like').style.color='#555';
                    document.getElementById('lb-like-count').innerText = likes.length - 1;
                } else {
                    await updateDoc(ref, { likes: arrayUnion(currentUser.uid) });
                    document.getElementById('lb-like').classList.add('liked');
                    document.getElementById('lb-like').style.color='red';
                    document.getElementById('lb-like-count').innerText = likes.length + 1;
                }
            } catch(e) { console.error(e); }
        }

        window.postReaction = async (text) => {
            if(!currentUser) return alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ t∆∞∆°ng t√°c! üí¨");
            const ref = doc(db, currentCollection, currentImgId);
            try {
                await updateDoc(ref, {
                    comments: arrayUnion({
                        uid: currentUser.uid,
                        name: currentUser.displayName,
                        avatar: currentUser.photoURL,
                        text: text,
                        time: Date.now()
                    })
                });
                const s = await getDoc(ref);
                renderComments(s.data().comments);
            } catch(e) { console.error(e); }
        }

        function renderComments(arr) {
            const list = document.getElementById('lb-cmt-list');
            list.innerHTML = "";
            if(!arr || arr.length === 0) {
                list.innerHTML = "<div style='text-align:center; color:#999; font-size:0.8rem; margin-top:20px;'>Ch∆∞a c√≥ c·∫£m x√∫c n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</div>";
                return;
            }
            // Show latest first
            [...arr].reverse().forEach(c => {
                list.innerHTML += `
                <div class="lb-reaction-item">
                    <img src="${c.avatar}" style="width:25px; height:25px; border-radius:50%;">
                    <div class="lb-reaction-bubble">
                        <strong>${c.name}</strong>: <span style="color:var(--primary); font-weight:bold;">${c.text}</span>
                    </div>
                </div>`;
            });
        }

        // 7. UPLOAD & AI GEMINI VISION
        window.checkLoginAndUpload = (c) => {
            if(!currentUser) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng b√†i!");
            currentCollection = c;
            // K√≠ch ho·∫°t hidden input
            document.getElementById('file-input').click();
        }

        window.executeUpload = async (input) => {
            const file = input.files[0];
            if(!file) return;
            
            const useAI = confirm("ü§ñ D√πng AI (Gemini 1.5 Flash) ƒë·ªÉ ph√¢n t√≠ch ·∫£nh v√† vi·∫øt caption t·ª± ƒë·ªông kh√¥ng?");
            let desc = "";
            
            document.getElementById('upload-overlay').style.display = 'flex';
            
            try {
                if(useAI) {
                    document.getElementById('upload-loading-text').innerText = "AI ƒëang ph√¢n t√≠ch ·∫£nh...";
                    const b64 = await new Promise((r) => {
                        const reader = new FileReader();
                        reader.onload = () => r(reader.result.split(',')[1]);
                        reader.readAsDataURL(file);
                    });
                    
                    // Prompt t·ªëi ∆∞u cho Gemini 1.5 Flash
                    const prompt = "H√£y ƒë√≥ng vai m·ªôt h·ªçc sinh th√¢n thi·ªán. M√¥ t·∫£ ng·∫Øn g·ªçn b·ª©c ·∫£nh n√†y (d∆∞·ªõi 30 t·ª´), t·∫≠p trung v√†o kh√¥ng kh√≠ vui v·∫ª ho·∫∑c √Ω nghƒ©a m√¥i tr∆∞·ªùng. D√πng ti·∫øng Vi·ªát.";
                    desc = await callGeminiAPI(prompt, b64);
                }
            } catch(e) {
                console.error(e);
                alert("AI ƒëang b·∫≠n, vui l√≤ng nh·∫≠p th·ªß c√¥ng.");
            }
            
            // N·∫øu AI l·ªói ho·∫∑c user kh√¥ng ch·ªçn AI th√¨ h·ªèi th·ªß c√¥ng
            if (!desc) {
                 document.getElementById('upload-overlay').style.display = 'none';
                 // setTimeout ƒë·ªÉ UI render l·∫°i tr∆∞·ªõc khi alert ch·∫∑n thread
                 await new Promise(r => setTimeout(r, 100)); 
                 desc = prompt("Nh·∫≠p m√¥ t·∫£ cho b·ª©c ·∫£nh n√†y:", ""); 
                 if(desc) document.getElementById('upload-overlay').style.display = 'flex';
            }

            if(!desc) { 
                document.getElementById('upload-overlay').style.display='none'; 
                input.value = ""; // Reset input
                return; 
            }

            // Cloudinary Upload
            document.getElementById('upload-loading-text').innerText = "ƒêang t·∫£i ·∫£nh l√™n Cloud...";
            const fd = new FormData();
            fd.append('file', file);
            fd.append('upload_preset', UPLOAD_PRESET);
            
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method:'POST', body:fd });
                const data = await res.json();
                
                if(data.error) throw new Error(data.error.message);

                await addDoc(collection(db, currentCollection), {
                    url: data.secure_url,
                    desc: desc,
                    uid: currentUser.uid,
                    authorName: currentUser.displayName,
                    authorAvatar: currentUser.photoURL,
                    createdAt: serverTimestamp(),
                    likes: [],
                    comments: []
                });
                alert("ƒêƒÉng b√†i th√†nh c√¥ng!");
            } catch(e) {
                alert("L·ªói upload: " + e.message);
            } finally {
                document.getElementById('upload-overlay').style.display = 'none';
                input.value = "";
            }
        }

        // 8. AI CHATBOT (GEMINI 1.5 FLASH REST API)
        window.toggleAIChat = () => {
            const w = document.getElementById('ai-window');
            w.style.display = w.style.display === 'flex' ? 'none' : 'flex';
        }

        window.sendMessageToAI = async (e) => {
            e.preventDefault();
            const input = document.getElementById('ai-input');
            const msg = input.value.trim();
            if(!msg) return;

            const box = document.getElementById('ai-messages');
            box.innerHTML += `<div class="ai-msg user">${msg}</div>`;
            input.value = "";
            box.scrollTop = box.scrollHeight;
            
            document.getElementById('ai-typing-indicator').style.display = 'block';

            // Context Prompt
            const systemPrompt = "B·∫°n l√† Green Bot, tr·ª£ l√Ω ·∫£o c·ªßa l·ªõp A2K41. B·∫°n th√¢n thi·ªán, h√†i h∆∞·ªõc, d√πng nhi·ªÅu emoji. B·∫°n gi√∫p tr·∫£ l·ªùi v·ªÅ b√†i t·∫≠p, l·ªãch h·ªçc ho·∫∑c ƒë∆°n gi·∫£n l√† tr√≤ chuy·ªán vui v·∫ª.";
            
            // X√¢y d·ª±ng history ƒë∆°n gi·∫£n ƒë·ªÉ g·ª≠i k√®m
            const contents = [
                { role: "user", parts: [{ text: systemPrompt + " User v·ª´a n√≥i: " + msg }] }
            ];

            try {
                // Call Gemini 1.5 Flash
                const reply = await callGeminiAPI(msg, null, true); // true = chat mode logic inside callGeminiAPI if needed, but here simple content gen is fine
                
                document.getElementById('ai-typing-indicator').style.display = 'none';
                box.innerHTML += `<div class="ai-msg bot">${parseMarkdown(reply)}</div>`;
                box.scrollTop = box.scrollHeight;
            } catch (err) {
                document.getElementById('ai-typing-indicator').style.display = 'none';
                box.innerHTML += `<div class="ai-msg bot" style="color:red">Bot ƒëang ng·ªß g·∫≠t... (L·ªói k·∫øt n·ªëi)</div>`;
            }
        }

        // Simple Markdown parser for AI bold text
        function parseMarkdown(text) {
            return text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        }

        // GENERIC GEMINI CALLER (Optimized)
        async function callGeminiAPI(text, imageBase64, isChat = false) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`;
            
            const parts = [{ text: text }];
            if (imageBase64) {
                parts.push({ inline_data: { mime_type: "image/jpeg", data: imageBase64 } });
            }

            const body = {
                contents: [{ parts: parts }]
            };
            
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            const data = await res.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text;
        }

        // 9. MUSIC PLAYER LOGIC
        window.toggleMusic = () => {
            const audio = document.getElementById('bg-music');
            const fab = document.getElementById('music-fab');
            
            if (isMusicPlaying) {
                audio.pause();
                fab.classList.remove('playing');
            } else {
                audio.play().catch(e => alert("Tr√¨nh duy·ªát ch·∫∑n t·ª± ph√°t nh·∫°c. H√£y t∆∞∆°ng t√°c v·ªõi trang web tr∆∞·ªõc!"));
                fab.classList.add('playing');
            }
            isMusicPlaying = !isMusicPlaying;
        }

        // 10. ADMIN & UTILS
        window.deletePost = async (c, i) => {
            if(confirm("Admin: X√≥a vƒ©nh vi·ªÖn b√†i n√†y?")) {
                await deleteDoc(doc(db, c, i));
                if(document.getElementById('lightbox').style.display === 'block') closeLightbox();
                if(c === activeArchiveTab) loadArchiveGrid();
            }
        }

        window.editPost = async (c, i, oldDesc) => {
            const newDesc = prompt("Admin Edit:", oldDesc);
            if(newDesc) {
                await updateDoc(doc(db, c, i), { desc: newDesc });
                if(document.getElementById('lightbox').style.display === 'block') {
                    document.getElementById('lb-desc').innerText = newDesc;
                }
                if(c === activeArchiveTab) loadArchiveGrid();
            }
        }

        window.showPage = (id) => {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            sessionStorage.setItem('page', id);
            
            document.querySelectorAll('nav.pc-nav a, .nav-item').forEach(a => a.classList.remove('active-menu'));
            if(document.getElementById('menu-pc-'+id)) document.getElementById('menu-pc-'+id).classList.add('active-menu');
            if(document.getElementById('mob-'+id)) document.getElementById('mob-'+id).classList.add('active-menu');

            if(id === 'archive') { loadArchiveSeasons(); window.loadArchiveGrid(); }
        }
        showPage(sessionStorage.getItem('page') || 'home');

        window.switchArchiveTab = (t) => {
            activeArchiveTab = t;
            document.querySelectorAll('.archive-tab').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-ar-'+t).classList.add('active');
            loadArchiveSeasons();
            loadArchiveGrid();
        }

        window.loadArchiveSeasons = async () => {
            const s = document.getElementById('archive-season-select');
            s.innerHTML = '<option value="ALL">üìÇ T·∫•t c·∫£ ƒë·ª£t</option>';
            // Note: archives_meta collection needs to be managed separately
        }

        window.checkAdminLogin = () => {
            const pwd = prompt("Nh·∫≠p m·∫≠t kh·∫©u Admin:");
            if(pwd === "A2K41VIP") { // Simple password logic
                document.getElementById('maintenance-overlay').style.display = 'none';
            } else {
                alert("Sai m·∫≠t kh·∫©u");
            }
        }

        window.loadAdminData = () => {
            // Placeholder for admin data loading
            alert("T√≠nh nƒÉng ƒëang c·∫≠p nh·∫≠t");
        }
        
        // Config Maintenance (Placeholder logic)
        window.updateMainConfig = () => {
            console.log("Update config");
        }

    </script>
</body>
</html>

