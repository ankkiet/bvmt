<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Green School - A2K41 | Ultimate</title>
    
    <meta name="theme-color" content="#2e7d32">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- DESIGN SYSTEM --- */
        :root { 
            --primary: #2e7d32; --primary-dark: #1b5e20;
            --accent: #ffca28; --danger: #d32f2f; --info: #0288d1;
            --bg: #f4f6f8; --text: #333; --white: #ffffff;
            --nav-height: 65px;
            --ai-color: #6200ea;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius: 16px;
        }

        /* --- GLOBAL --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Nunito', sans-serif; margin: 0; padding: 0; 
            background-color: var(--bg); color: var(--text); padding-bottom: 100px;
        }
        h1, h2, h3 { font-family: 'Quicksand', sans-serif; color: var(--primary); margin-top: 0; }
        
        /* --- LAYOUT --- */
        .container { 
            max-width: 1100px; width: 95%; margin: 20px auto; 
            background: var(--white); padding: 25px; border-radius: var(--radius); 
            box-shadow: var(--shadow); min-height: 80vh; 
        }

        /* Navigation */
        nav.pc-nav { 
            background: linear-gradient(to right, var(--primary), var(--primary-dark)); 
            padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); 
        }
        nav.pc-nav ul { list-style: none; margin: 0; padding: 0; display: flex; justify-content: center; gap: 15px; }
        nav.pc-nav a { 
            color: var(--white); text-decoration: none; font-weight: 700; text-transform: uppercase; 
            padding: 10px 18px; border-radius: 30px; transition: 0.3s; cursor: pointer; font-size: 0.9rem;
        }
        nav.pc-nav a:hover, nav.pc-nav a.active-menu { background: rgba(255,255,255,0.25); color: var(--accent); }

        nav.mobile-nav { 
            display: none; position: fixed; bottom: 0; left: 0; width: 100%; 
            background: white; border-top: 1px solid #eee; z-index: 1000; 
            padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .mobile-nav-inner { display: flex; overflow-x: auto; }
        .nav-item { 
            flex: 1; min-width: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            color: #999; padding: 8px; font-size: 0.7rem; cursor: pointer; white-space: nowrap;
        }
        .nav-item.active-menu { color: var(--primary); font-weight: 800; }
        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; }

        /* UI Elements */
        .page-section { display: none; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: #fff; border: 1px solid #eee; border-radius: 12px; 
            padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
        }
        
        .btn { 
            background: var(--primary); color: white; border: none; padding: 10px 20px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; 
            display: inline-flex; align-items: center; gap: 8px; font-size: 0.95rem;
        }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-ai { background: linear-gradient(135deg, #6200ea, #b388ff); color: white; border: none; }
        .btn-trash { background: linear-gradient(135deg, #ff9800, #f57c00); color: white; border: none; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }

        input, select, textarea { 
            width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; 
            border-radius: 8px; background: #fafafa; font-size: 1rem; 
        }
        
        /* Gallery & Ranking */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .gallery-item { border-radius: 10px; overflow: hidden; border: 1px solid #eee; cursor: pointer; transition: 0.3s; position: relative; background:white; }
        .gallery-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .gallery-img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .gallery-info { padding: 10px; font-size: 0.9rem; }
        .badge { position: absolute; top: 10px; left: 10px; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        
        .ranking-wrapper { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
        .ranking-card { flex: 1; min-width: 300px; border: 1px solid #eee; border-radius: 12px; overflow: hidden; }
        .rank-header { background: var(--primary); color: white; padding: 10px; font-weight: bold; text-align: center; }
        .rank-header.class-rank { background: var(--info); }
        .rank-table { width: 100%; border-collapse: collapse; }
        .rank-table td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .rank-top { background: #fffde7; font-weight: bold; color: #f57f17; }

        /* Lightbox */
        .modal { display: none; position: fixed; z-index: 9999; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); overflow-y: auto; padding: 20px 0; }
        .lb-container { margin: 20px auto; width: 95%; max-width: 900px; background: white; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; max-height: 90vh; }
        .lb-close { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; width: 30px; height: 30px; border-radius: 50%; border:none; cursor: pointer; z-index: 100; font-weight: bold; }
        .lb-img-area { background: #000; height: 50vh; display: flex; align-items: center; justify-content: center; }
        .lb-img-area img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .lb-details { padding: 15px; background: white; flex: 1; display: flex; flex-direction: column; }
        .lb-comments { flex: 1; overflow-y: auto; background: #f9f9f9; padding: 10px; margin: 10px 0; border-radius: 8px; max-height: 150px; }

        /* AI Chat & FAB */
        .ai-chat-window { 
            position: fixed; bottom: 100px; right: 20px; width: 350px; height: 450px; 
            background: white; border-radius: 16px; box-shadow: 0 5px 25px rgba(0,0,0,0.15); 
            z-index: 2000; display: none; flex-direction: column; overflow: hidden; border: 1px solid #eee;
        }
        .ai-msg { padding: 8px 12px; margin: 5px; border-radius: 10px; max-width: 80%; font-size: 0.9rem; }
        .ai-msg.user { background: var(--ai-color); color: white; align-self: flex-end; }
        .ai-msg.bot { background: #f1f1f1; color: #333; align-self: flex-start; }

        .fab-btn {
            position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1500; transition: 0.3s;
        }
        .fab-ai { background: linear-gradient(135deg, #6200ea, #b388ff); bottom: 90px; }
        .fab-music { background: white; color: var(--primary); border: 2px solid var(--primary); bottom: 20px; }
        
        #loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.95); z-index: 9999; display: flex; 
            flex-direction: column; align-items: center; justify-content: center;
        }

        @media (max-width: 768px) {
            nav.pc-nav { display: none; }
            nav.mobile-nav { display: block; }
            .container { margin: 0; width: 100%; border-radius: 0; box-shadow: none; }
            .ai-chat-window { width: 90%; right: 5%; bottom: 160px; }
            .ranking-wrapper { flex-direction: column; }
            .lb-container { margin: 0; width: 100%; height: 100%; max-height: none; border-radius: 0; }
        }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="loader" style="display:none;">
        <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary)"></i>
        <h3 style="margin-top:15px; color:var(--primary)" id="loader-text">ƒêang x·ª≠ l√Ω...</h3>
    </div>

    <!-- Lightbox Modal (Restored) -->
    <div id="lightbox" class="modal" onclick="if(event.target==this) App.closeLightbox()">
        <div class="lb-container">
            <button class="lb-close" onclick="App.closeLightbox()">X</button>
            <div class="lb-img-area"><img id="lb-img"></div>
            <div class="lb-details">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <img id="lb-avatar" style="width:40px; height:40px; border-radius:50%;">
                    <div><b id="lb-author">Name</b><br><span id="lb-date" style="font-size:0.8rem; color:#666">Date</span></div>
                </div>
                <p id="lb-desc">Description</p>
                <div style="display:flex; gap:15px; margin:10px 0; color:#555;">
                    <span id="lb-like-btn" onclick="App.handleLike()" style="cursor:pointer"><i class="fas fa-heart"></i> <span id="lb-likes">0</span></span>
                    <span><i class="fas fa-comment"></i> B√¨nh lu·∫≠n</span>
                </div>
                <div class="lb-comments" id="lb-comments-list"></div>
                <form onsubmit="App.postComment(event)" style="display:flex; gap:5px; margin-top:auto;">
                    <input id="lb-cmt-input" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." required style="margin:0; border-radius:20px;">
                    <button class="btn btn-sm" style="border-radius:20px;">G·ª≠i</button>
                </form>
            </div>
        </div>
    </div>

    <!-- AI Chat Window -->
    <div class="ai-chat-window" id="ai-window">
        <div style="background:var(--ai-color); color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
            <span>ü§ñ Green Bot</span><span onclick="App.toggleChat()" style="cursor:pointer;">&times;</span>
        </div>
        <div id="ai-messages" style="flex:1; padding:10px; overflow-y:auto; background:#fafafa;">
            <div class="ai-msg bot">Ch√†o b·∫°n! T·ªõ l√† tr·ª£ l√Ω ·∫£o AI. C·∫ßn gi√∫p g√¨ c·ª© h·ªèi nh√©!</div>
        </div>
        <form onsubmit="App.sendChat(event)" style="padding:10px; border-top:1px solid #eee; display:flex; gap:5px;">
            <input id="chat-input" placeholder="H·ªèi g√¨ ƒë√≥..." style="margin:0; border-radius:20px;">
            <button class="btn btn-ai btn-sm" style="border-radius:50%; width:40px; height:40px; padding:0; display:flex; justify-content:center;"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>

    <!-- FABs -->
    <div class="fab-btn fab-ai" onclick="App.toggleChat()"><i class="fas fa-robot"></i></div>
    <div class="fab-btn fab-music" onclick="App.toggleMusic()">
        <i class="fas fa-music" id="music-icon"></i>
        <div id="player" style="display:none;"></div>
    </div>

    <!-- PC Nav -->
    <nav class="pc-nav">
        <ul>
            <li><a onclick="App.nav('home')" id="lnk-home">Trang Ch·ªß</a></li>
            <li><a onclick="App.nav('green')" id="lnk-green">G√≥c Xanh</a></li>
            <li><a onclick="App.nav('contest')" id="lnk-contest">Thi ƒêua</a></li>
            <li><a onclick="App.nav('archive')" id="lnk-archive">L∆∞u Tr·ªØ</a></li>
            <li><a onclick="App.nav('activities')" id="lnk-activities">Ho·∫°t ƒê·ªông</a></li>
            <li><a onclick="App.nav('guide')" id="lnk-guide">Tra C·ª©u</a></li>
            <li><a onclick="App.nav('profile')" id="lnk-profile">C√° Nh√¢n</a></li>
            <li><a onclick="App.nav('admin')" id="lnk-admin" style="display:none">Admin</a></li>
        </ul>
    </nav>

    <!-- Content -->
    <div class="container">
        
        <!-- HOME -->
        <div id="home" class="page-section active">
            <div style="text-align:center; padding:20px 0;">
                <h1 style="font-size:2rem; margin-bottom:10px;">Green School - A2K41</h1>
                <p style="color:#666;">H√†nh ƒë·ªông nh·ªè - √ù nghƒ©a l·ªõn</p>
                <img src="https://images.pexels.com/photos/7656720/pexels-photo-7656720.jpeg" style="width:100%; max-height:300px; object-fit:cover; border-radius:12px; margin:20px 0;">
                <div id="auth-area"><button class="btn btn-outline" onclick="App.login()"><i class="fab fa-google"></i> ƒêƒÉng nh·∫≠p ngay</button></div>
                <div id="welcome-area" style="display:none;"><h3>Xin ch√†o, <span id="user-display-name">User</span>!</h3></div>
            </div>
            <div class="card" style="border-left:5px solid var(--accent); background:#fffde7;">
                <h3>üí° Tip H√¥m Nay</h3><p id="daily-tip">Loading...</p>
            </div>
        </div>

        <!-- GREEN CLASS (Restored Ranking) -->
        <div id="green" class="page-section">
            <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; margin-bottom:20px;">
                <h2>üåø G√≥c Xanh</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-trash" onclick="App.upload('trash')"><i class="fas fa-search"></i> AI Soi R√°c</button>
                    <button class="btn" onclick="App.upload('gallery')"><i class="fas fa-camera"></i> ƒêƒÉng ·∫¢nh</button>
                </div>
            </div>
            <!-- Dual Ranking Restored -->
            <div class="ranking-wrapper">
                <div class="ranking-card">
                    <div class="rank-header">üèÜ Top C√° Nh√¢n</div>
                    <table class="rank-table"><tbody id="green-rank-user"><tr><td>ƒêang t√≠nh...</td></tr></tbody></table>
                </div>
                <div class="ranking-card">
                    <div class="rank-header class-rank">üè´ Top L·ªõp</div>
                    <table class="rank-table"><tbody id="green-rank-class"><tr><td>ƒêang t√≠nh...</td></tr></tbody></table>
                </div>
            </div>
            <div id="gallery-container" class="gallery-grid"></div>
        </div>

        <!-- CONTEST (Restored) -->
        <div id="contest" class="page-section">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2>üèÜ Phong Tr√†o Thi ƒêua</h2>
                <button class="btn" style="background:var(--info)" onclick="App.upload('contest')"><i class="fas fa-trophy"></i> N·ªôp B√°o C√°o</button>
            </div>
            <div class="ranking-wrapper">
                <div class="ranking-card">
                    <div class="rank-header">üèÜ Top C√° Nh√¢n</div>
                    <table class="rank-table"><tbody id="contest-rank-user"><tr><td>ƒêang t√≠nh...</td></tr></tbody></table>
                </div>
                <div class="ranking-card">
                    <div class="rank-header class-rank">üè´ Top L·ªõp</div>
                    <table class="rank-table"><tbody id="contest-rank-class"><tr><td>ƒêang t√≠nh...</td></tr></tbody></table>
                </div>
            </div>
            <div id="contest-container" class="gallery-grid"></div>
        </div>

        <!-- ARCHIVE (Restored) -->
        <div id="archive" class="page-section">
            <h2>üóÑÔ∏è Kho L∆∞u Tr·ªØ</h2>
            <div class="card">
                <p>Xem l·∫°i c√°c ho·∫°t ƒë·ªông ƒë√£ qua.</p>
                <select id="archive-filter" onchange="App.loadArchive()" style="margin-bottom:15px;">
                    <option value="all">üìÇ T·∫•t c·∫£</option>
                    <option value="trash">‚ôªÔ∏è Ph√¢n lo·∫°i r√°c</option>
                    <option value="contest">üèÜ Thi ƒëua c≈©</option>
                </select>
                <div id="archive-container" class="gallery-grid"></div>
            </div>
        </div>

        <!-- ACTIVITIES (Restored) -->
        <div id="activities" class="page-section">
            <h2>üìÖ Ho·∫°t ƒê·ªông & Tin T·ª©c</h2>
            <div class="card">
                <h3>‚ôªÔ∏è ƒê·ªïi gi·∫•y l·∫•y c√¢y</h3>
                <p>‚è∞ Th·ªùi gian: Th·ª© 5 h√†ng tu·∫ßn, 15:00 - 17:00</p>
                <p>üìç ƒê·ªãa ƒëi·ªÉm: Ph√≤ng ƒê·ªôi</p>
            </div>
            <div class="card" style="border-left:5px solid #039be5">
                <h3>üì¢ Th√¥ng B√°o M·ªõi</h3>
                <ul style="padding-left:20px">
                    <li>L·ªÖ ra qu√¢n "Ng√†y Ch·ªß Nh·∫≠t Xanh" v√†o tu·∫ßn t·ªõi.</li>
                    <li>C√°c l·ªõp n·ªôp k·∫ø ho·∫°ch K·∫ø Ho·∫°ch Nh·ªè tr∆∞·ªõc ng√†y 20.</li>
                </ul>
            </div>
        </div>

        <!-- GUIDE (Restored) -->
        <div id="guide" class="page-section">
            <h2>üîç Tra C·ª©u Ph√¢n Lo·∫°i R√°c</h2>
            <div class="card">
                <p>Nh·∫≠p t√™n r√°c ƒë·ªÉ tra c·ª©u th·ªß c√¥ng (N·∫øu AI ch∆∞a ch√≠nh x√°c).</p>
                <input type="text" id="guide-search" placeholder="Nh·∫≠p t√™n r√°c (v·ªè s·ªØa, pin, gi·∫•y...)" onkeyup="App.searchGuide()">
                <div id="guide-result" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;"></div>
            </div>
        </div>

        <!-- PROFILE & ADMIN -->
        <div id="profile" class="page-section">
            <h2>üë§ H·ªì S∆°</h2>
            <div class="card" style="text-align:center;">
                <img id="pf-avatar" src="" style="width:100px; height:100px; border-radius:50%; margin-bottom:15px; border:4px solid #eee;">
                <h3 id="pf-name">T√™n User</h3>
                <p id="pf-email" style="color:#888;">email@example.com</p>
                <div style="text-align:left; max-width:400px; margin:20px auto;">
                    <label>L·ªõp:</label>
                    <select id="pf-class"><option value="">-- Ch·ªçn --</option><option value="12A1">12A1</option><option value="11A1">11A1</option><option value="GV">Gi√°o Vi√™n</option></select>
                    <button class="btn" style="width:100%; margin-top:10px;" onclick="App.saveProfile()">L∆∞u H·ªì S∆°</button>
                </div>
                <button class="btn btn-danger" onclick="App.logout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>

        <div id="admin" class="page-section">
            <h2>üõ† Qu·∫£n Tr·ªã Vi√™n</h2>
            <div class="card" style="border-left:5px solid var(--ai-color);">
                <h3>ü§ñ API Key</h3>
                <div style="display:flex; gap:10px;"><input type="password" id="adm-key" placeholder="Nh·∫≠p Key..." style="flex:1"><button class="btn" onclick="App.saveKey()">L∆∞u</button></div>
                <p id="key-status" style="margin-top:5px; font-weight:bold; color:green"></p>
            </div>
            <div class="card"><h3>üéµ Nh·∫°c N·ªÅn</h3><input id="adm-music" placeholder="YouTube ID"><button class="btn btn-sm" onclick="App.saveMusic()">L∆∞u</button></div>
        </div>
    </div>

    <!-- Hidden Input -->
    <input type="file" id="file-input" accept="image/*" style="display:none;" onchange="App.processFile(this)">

    <!-- Mobile Nav -->
    <nav class="mobile-nav">
        <div class="mobile-nav-inner">
            <div class="nav-item" onclick="App.nav('home')" id="mob-home"><i class="fas fa-home"></i>Home</div>
            <div class="nav-item" onclick="App.nav('green')" id="mob-green"><i class="fas fa-leaf"></i>G√≥c Xanh</div>
            <div class="nav-item" onclick="App.nav('contest')" id="mob-contest"><i class="fas fa-trophy"></i>Thi ƒêua</div>
            <div class="nav-item" onclick="App.nav('archive')" id="mob-archive"><i class="fas fa-box"></i>L∆∞u Tr·ªØ</div>
            <div class="nav-item" onclick="App.nav('activities')" id="mob-activities"><i class="fas fa-calendar"></i>Hƒê</div>
            <div class="nav-item" onclick="App.nav('guide')" id="mob-guide"><i class="fas fa-search"></i>Tra C·ª©u</div>
            <div class="nav-item" onclick="App.nav('profile')" id="mob-profile"><i class="fas fa-user"></i>T√¥i</div>
        </div>
    </nav>

    <!-- SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCJ_XI_fq-yJC909jb9KLIKg3AfGdm6hNs", authDomain: "a2k41nvc-36b0b.firebaseapp.com", projectId: "a2k41nvc-36b0b", storageBucket: "a2k41nvc-36b0b.firebasestorage.app", messagingSenderId: "279516631226", appId: "1:279516631226:web:99012883ed7923ab5c3283" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app); const provider = new GoogleAuthProvider();
        const CLOUD_NAME = "dekxvneap"; const UPLOAD_PRESET = "a2k41nvc_upload"; const ADMIN_EMAILS = ["kiet0905478167@gmail.com", "anhkiet119209@gmail.com"];

        const State = { user: null, isAdmin: false, config: { geminiKey: "", musicId: "jfKfPfyJRdk" }, uploadType: 'gallery', currentImg: null, currentCol: null };

        const Utils = {
            loader: (s, t="ƒêang x·ª≠ l√Ω...") => { document.getElementById('loader').style.display=s?'flex':'none'; document.getElementById('loader-text').innerText=t; },
            fileToBase64: (f) => new Promise((r, j) => { const rd = new FileReader(); rd.readAsDataURL(f); rd.onload = () => r(rd.result.split(',')[1]); rd.onerror = j; })
        };

        const AIService = {
            async generate(prompt, img64) {
                if (!State.config.geminiKey) return "‚ö†Ô∏è Thi·∫øu API Key.";
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${State.config.geminiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, ...(img64?[{ inline_data: { mime_type: "image/jpeg", data: img64 } }]:[])] }] })
                    });
                    const d = await res.json();
                    return d.candidates?.[0]?.content?.parts?.[0]?.text || "AI Error";
                } catch (e) { return "AI Error: " + e.message; }
            }
        };

        const App = {
            init: async () => {
                App.listenAuth(); App.listenConfig(); App.setupYouTube();
                App.listenCollection('gallery', 'gallery-container', 'green-rank');
                App.listenCollection('contest', 'contest-container', 'contest-rank');
                App.loadArchive(); App.searchGuide(); // Load Guide data
                document.getElementById('daily-tip').innerText = ["T·∫Øt ƒë√®n khi ra kh·ªèi ph√≤ng.", "Ph√¢n lo·∫°i r√°c t·∫°i ngu·ªìn.", "Tr·ªìng c√¢y xanh."][Math.floor(Math.random()*3)];
            },
            
            nav: (id) => {
                document.querySelectorAll('.page-section').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active');
                document.querySelectorAll('nav a, .nav-item').forEach(e=>e.classList.remove('active-menu'));
                if(document.getElementById('lnk-'+id)) document.getElementById('lnk-'+id).classList.add('active-menu');
                if(document.getElementById('mob-'+id)) document.getElementById('mob-'+id).classList.add('active-menu');
            },

            login: () => signInWithPopup(auth, provider),
            logout: () => signOut(auth).then(()=>location.reload()),
            
            listenAuth: () => {
                onAuthStateChanged(auth, async (u) => {
                    State.user = u;
                    if (u) {
                        State.isAdmin = ADMIN_EMAILS.includes(u.email);
                        const r = doc(db, "users", u.uid); const s = await getDoc(r);
                        if (!s.exists()) await setDoc(r, { uid: u.uid, email: u.email, name: u.displayName, photo: u.photoURL, role: State.isAdmin?'admin':'user' });
                        else if(s.data().class) document.getElementById('pf-class').value = s.data().class;
                        
                        document.getElementById('auth-area').style.display='none'; document.getElementById('welcome-area').style.display='block';
                        document.getElementById('user-display-name').innerText=u.displayName;
                        document.getElementById('pf-avatar').src=u.photoURL; document.getElementById('pf-name').innerText=u.displayName; document.getElementById('pf-email').innerText=u.email;
                        if(State.isAdmin) { document.getElementById('lnk-admin').style.display='block'; document.getElementById('key-status').innerText="Admin Access"; }
                    } else {
                        document.getElementById('auth-area').style.display='block'; document.getElementById('welcome-area').style.display='none';
                        document.getElementById('lnk-admin').style.display='none'; App.nav('home');
                    }
                });
            },

            saveProfile: async () => { if(!State.user) return; await updateDoc(doc(db, "users", State.user.uid), { class: document.getElementById('pf-class').value }); alert("Saved!"); },
            listenConfig: () => onSnapshot(doc(db, "settings", "config"), (d) => { if(d.exists()) { State.config={...State.config, ...d.data()}; if(State.isAdmin && State.config.geminiKey) document.getElementById('adm-key').placeholder="Key saved"; } }),
            saveKey: async () => { await setDoc(doc(db, "settings", "config"), { geminiKey: document.getElementById('adm-key').value }, { merge: true }); alert("Saved Key!"); },
            saveMusic: async () => { await setDoc(doc(db, "settings", "config"), { musicId: document.getElementById('adm-music').value }, { merge: true }); alert("Saved Music!"); },

            upload: (t) => { if(!State.user) return alert("Login first!"); State.uploadType=t; document.getElementById('file-input').click(); },
            processFile: async (inp) => {
                const f=inp.files[0]; if(!f) return;
                const isTrash = State.uploadType==='trash';
                let col = State.uploadType==='contest' ? 'contest' : 'gallery';
                let prompt = isTrash ? "ƒê√¢y l√† r√°c g√¨? H·ªØu c∆° hay t√°i ch·∫ø? Ch·ªâ c√°ch v·ª©t." : "Vi·∫øt caption ng·∫Øn vui v·ªÅ m√¥i tr∆∞·ªùng cho ·∫£nh n√†y.";
                if(State.uploadType==='contest') prompt = "Vi·∫øt caption ng·∫Øn cho b√°o c√°o thi ƒëua n√†y.";

                Utils.loader(true, isTrash?"AI Soi R√°c...":"Uploading...");
                try {
                    const fd = new FormData(); fd.append('file', f); fd.append('upload_preset', UPLOAD_PRESET);
                    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {method:'POST', body:fd});
                    const d = await res.json();
                    if(d.secure_url) {
                        const b64 = await Utils.fileToBase64(f);
                        let desc = await AIService.generate(prompt, b64);
                        if(isTrash) alert(`ü§ñ AI Result:\n${desc}`);
                        await addDoc(collection(db, col), { url: d.secure_url, desc, type: State.uploadType, uid: State.user.uid, author: State.user.displayName, avatar: State.user.photoURL, className: document.getElementById('pf-class').value || "Kh√°c", createdAt: serverTimestamp(), likes: [], comments: [] });
                        if(!isTrash) alert("Posted!");
                    }
                } catch(e) { alert("Error: "+e.message); } finally { Utils.loader(false); inp.value=""; }
            },

            listenCollection: (col, divId, rankPrefix) => {
                onSnapshot(query(collection(db, col), orderBy("createdAt", "desc")), (snap) => {
                    const div = document.getElementById(divId); div.innerHTML = "";
                    const uC={}, cC={};
                    snap.forEach(d => {
                        const i = d.data();
                        if(!uC[i.author]) uC[i.author]=0; uC[i.author]++;
                        const cl = i.className || "Kh√°c"; if(!cC[cl]) cC[cl]=0; cC[cl]++;
                        
                        let badge = "";
                        if(i.type==='trash') badge='<span class="badge" style="background:orange">AI Scan</span>';
                        else if(col==='contest') badge='<span class="badge" style="background:var(--info)">Contest</span>';

                        div.innerHTML += `<div class="gallery-item" onclick="App.openLightbox('${col}','${d.id}')">
                            ${badge}<img src="${i.url}" class="gallery-img">
                            <div class="gallery-info"><b>${i.desc}</b><br><small>${i.author}</small></div>
                        </div>`;
                    });
                    // Rankings
                    const ren = (obj, id) => {
                        const s = Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,5);
                        const t = document.getElementById(id); if(!t) return;
                        t.innerHTML = s.map((x,n)=>`<tr class="${n==0?'rank-top':''}"><td>${n+1}</td><td>${x[0]}</td><td>${x[1]}</td></tr>`).join('') || "<tr><td>Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>";
                    };
                    ren(uC, `${rankPrefix}-user`); ren(cC, `${rankPrefix}-class`);
                });
            },

            // LIGHTBOX RESTORED
            openLightbox: async (col, id) => {
                State.currentImg = id; State.currentCol = col;
                const d = await getDoc(doc(db, col, id)); if(!d.exists()) return;
                const i = d.data();
                document.getElementById('lb-img').src = i.url;
                document.getElementById('lb-avatar').src = i.avatar;
                document.getElementById('lb-author').innerText = i.author;
                document.getElementById('lb-date').innerText = i.createdAt ? new Date(i.createdAt.seconds*1000).toLocaleDateString() : '';
                document.getElementById('lb-desc').innerText = i.desc;
                document.getElementById('lb-likes').innerText = i.likes ? i.likes.length : 0;
                document.getElementById('lightbox').style.display = 'flex';
                App.renderComments(i.comments || []);
            },
            closeLightbox: () => document.getElementById('lightbox').style.display='none',
            handleLike: async () => {
                if(!State.user) return;
                const ref = doc(db, State.currentCol, State.currentImg);
                const s = await getDoc(ref); const l = s.data().likes || [];
                if(l.includes(State.user.uid)) await updateDoc(ref, {likes: arrayRemove(State.user.uid)});
                else await updateDoc(ref, {likes: arrayUnion(State.user.uid)});
                const n = await getDoc(ref); document.getElementById('lb-likes').innerText = n.data().likes.length;
            },
            postComment: async (e) => {
                e.preventDefault(); if(!State.user) return;
                const t = document.getElementById('lb-cmt-input').value;
                const c = { uid: State.user.uid, name: State.user.displayName, text: t, time: Date.now() };
                await updateDoc(doc(db, State.currentCol, State.currentImg), { comments: arrayUnion(c) });
                document.getElementById('lb-cmt-input').value = "";
                const n = await getDoc(doc(db, State.currentCol, State.currentImg)); App.renderComments(n.data().comments);
            },
            renderComments: (arr) => {
                const d = document.getElementById('lb-comments-list'); d.innerHTML = "";
                arr.forEach(c => d.innerHTML += `<div style="margin-bottom:8px; font-size:0.9rem;"><b>${c.name}:</b> ${c.text}</div>`);
            },

            // ARCHIVE & GUIDE RESTORED
            loadArchive: async () => {
                const fil = document.getElementById('archive-filter')?.value || 'all';
                let q = query(collection(db, "gallery"), orderBy("createdAt", "desc")); // Simplified for demo
                // In real app, implement filter logic here or fetch from 'archives' collection
                const sn = await getDocs(q);
                const d = document.getElementById('archive-container'); if(d) d.innerHTML = "";
                sn.forEach(doc => {
                    const i = doc.data();
                    if(fil !== 'all' && i.type !== fil) return;
                    if(d) d.innerHTML += `<div class="gallery-item"><img src="${i.url}" class="gallery-img"><div class="gallery-info">${i.desc}</div></div>`;
                });
            },
            searchGuide: () => {
                const k = document.getElementById('guide-search')?.value.toLowerCase() || "";
                const data = [
                    {n:"V·ªè s·ªØa",t:"T√°i ch·∫ø",c:"green"},{n:"Chai nh·ª±a",t:"T√°i ch·∫ø",c:"green"},
                    {n:"V·ªè chu·ªëi",t:"H·ªØu c∆°",c:"orange"},{n:"L√° c√¢y",t:"H·ªØu c∆°",c:"orange"},
                    {n:"T√∫i nilon",t:"R√°c kh√°c",c:"gray"}
                ];
                const res = document.getElementById('guide-result'); if(!res) return;
                res.innerHTML = "";
                data.filter(i=>i.n.toLowerCase().includes(k)).forEach(i => {
                    res.innerHTML += `<div style="padding:10px; background:#f0f0f0; border-radius:8px; border-left:5px solid ${i.c}"><b>${i.n}</b><br>${i.t}</div>`;
                });
            },

            // CHAT & MUSIC
            toggleChat: () => { const w=document.getElementById('ai-window'); w.style.display = w.style.display==='flex'?'none':'flex'; },
            sendChat: async (e) => {
                e.preventDefault(); const i=document.getElementById('chat-input'); const t=i.value; if(!t)return;
                const b=document.getElementById('ai-messages'); b.innerHTML+=`<div class="ai-msg user">${t}</div>`; i.value="";
                const r=await AIService.generate("B·∫°n l√† Green Bot. Tr·∫£ l·ªùi: "+t);
                b.innerHTML+=`<div class="ai-msg bot">${r}</div>`; b.scrollTop=b.scrollHeight;
            },
            setupYouTube: () => { const t=document.createElement('script'); t.src="https://www.youtube.com/iframe_api"; document.body.appendChild(t); window.onYouTubeIframeAPIReady=()=>{State.player=new YT.Player('player',{height:'0',width:'0',videoId:State.config.musicId});} },
            toggleMusic: () => { if(State.player && State.player.getPlayerState) { if(State.player.getPlayerState()===1){State.player.pauseVideo(); document.getElementById('music-icon').classList.remove('fa-spin');} else {State.player.playVideo(); document.getElementById('music-icon').classList.add('fa-spin');} } }
        };
        window.App = App; App.init();
    </script>
</body>
</html>
