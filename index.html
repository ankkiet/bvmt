<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Green School - Tr∆∞·ªùng H·ªçc Xanh</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS CHUNG --- */
        :root { --primary-color: #2e7d32; --secondary-color: #a5d6a7; --accent-color: #ffca28; --text-color: #333; --white: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Nunito', sans-serif; margin: 0; padding: 0; background-color: #f0f7f0; color: var(--text-color); padding-bottom: 80px; }
        
        nav { background-color: var(--primary-color); padding: 10px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        nav ul { list-style: none; text-align: center; margin: 0; padding: 0; white-space: nowrap; overflow-x: auto; display: flex; justify-content: center; -webkit-overflow-scrolling: touch; }
        nav ul::-webkit-scrollbar { display: none; }
        nav ul li { display: inline-block; margin: 0 5px; flex-shrink: 0; }
        nav ul li a { color: var(--white); text-decoration: none; font-weight: 700; cursor: pointer; text-transform: uppercase; padding: 8px 12px; display: block; font-size: 0.9rem; border-radius: 20px; transition: 0.3s; }
        nav ul li a:hover, nav ul li a.active-menu { background-color: rgba(255,255,255,0.2); color: var(--accent-color); }

        .container { max-width: 1000px; margin: 20px auto; background: var(--white); padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 80vh; }
        .page-section { display: none; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2, h3 { font-family: 'Quicksand', sans-serif; color: var(--primary-color); text-align: center; margin-top: 0; }
        h1 { border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; font-size: 1.8rem; }
        .card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .btn { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-right: 5px; font-size: 0.95rem; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-google { background: #DB4437; color: white; width: 100%; max-width: 300px; margin: 10px auto; display: block; }
        .btn-outline { background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; font-family: inherit; font-size: 1rem; }

        .search-box { position: relative; max-width: 500px; margin: 0 auto 20px auto; }
        .search-box input { padding-left: 40px; border-radius: 25px; border: 2px solid var(--primary-color); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--primary-color); }
        .trash-result { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .trash-item { border: 1px solid #eee; padding: 15px; border-radius: 8px; text-align: center; transition: 0.3s; }
        .trash-item:hover { transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .trash-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
        .bin-type { display: inline-block; padding: 5px 10px; border-radius: 15px; color: white; font-size: 0.8rem; font-weight: bold; margin-top: 5px; }
        .bin-organic { background-color: #4CAF50; } .bin-recycle { background-color: #2196F3; } .bin-other { background-color: #FF9800; } .bin-hazardous { background-color: #f44336; }

        /* --- CSS L·ªöP H·ªåC XANH (ƒê√É CH·ªàNH S·ª¨A CHO ƒê·∫∏P) --- */
        .green-class-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .green-class-item { position: relative; overflow: hidden; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.3s ease; }
        .green-class-item:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .green-class-img { width: 100%; height: 250px; object-fit: cover; transition: transform 0.5s ease; display: block;}
        .green-class-item:hover .green-class-img { transform: scale(1.1); }
        .green-class-info { position: absolute; bottom: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0)); color: white; width: 100%; padding: 20px 15px 15px 15px; }

        .contest-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .contest-item { border: 1px solid #eee; border-radius: 8px; overflow: hidden; background: #fff; display: flex; flex-direction: column; position: relative; }
        .contest-link-wrapper { display: flex; align-items: center; justify-content: center; position: relative; width: 100%; height: 200px; background: #f8f9fa; text-decoration: none; overflow: hidden; }
        .contest-img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .link-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; z-index: 2; }
        .click-hint { position: absolute; bottom: 0; width: 100%; background: rgba(46, 125, 50, 0.9); color: white; text-align: center; padding: 8px; font-size: 0.9rem; opacity: 0; transition: 0.3s; }
        .contest-link-wrapper:hover .click-hint { opacity: 1; }
        .contest-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .btn-heart { background: #eee; color: #333; width: 100%; padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-heart.liked { background: #ffebee; color: #e53935; border: 1px solid #e53935; }
        .contest-tools { position: absolute; top: 10px; left: 10px; display: flex; gap: 5px; z-index: 5; }
        .tool-btn { background: rgba(255,255,255,0.9); border: 1px solid #ddd; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        
        .ranking-container { display: flex; gap: 20px; margin-top: 30px; }
        .ranking-box { flex: 1; min-width: 0; background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 15px; border-top: 5px solid var(--accent-color); }
        .rank-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .rank-table th { text-align: left; padding: 8px; color: #777; border-bottom: 1px solid #eee; }
        .rank-table td { padding: 10px 8px; border-bottom: 1px solid #f5f5f5; }
        .top-1 { color: #d4af37; font-weight: bold; } 

        .comment-item { padding: 15px 0; border-bottom: 1px solid #eee; }
        .comment-main { display: flex; gap: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .comment-content { flex: 1; }
        .comment-text { background: #f1f2f6; padding: 8px 12px; border-radius: 15px; display: inline-block; margin-top: 5px; white-space: pre-wrap; }
        .comment-actions { margin-top: 5px; font-size: 0.8rem; display: flex; gap: 10px; align-items: center; color: #777; }
        .action-link { cursor: pointer; color: var(--primary-color); font-weight: 600; text-decoration: none; }
        .action-delete { color: #e53935; }
        .replies-container { margin-left: 50px; margin-top: 10px; border-left: 2px solid #eee; padding-left: 10px; }
        .reply-item { display: flex; gap: 10px; margin-top: 10px; }
        .reply-form-container { margin-left: 50px; margin-top: 10px; display: none; }

        .qr-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; display: flex; flex-direction: column; align-items: center; }
        .qr-box { background: white; padding: 10px; border: 1px solid #ddd; border-radius: 8px; display: inline-block; }
        footer { text-align: center; padding: 20px; color: #777; margin-top: 20px; border-top: 1px solid #eee; font-size: 0.9rem; }

        @media (max-width: 768px) {
            .container { margin: 10px; padding: 15px; width: auto; }
            nav ul { justify-content: flex-start; padding: 0 10px; }
            .ranking-container { flex-direction: column; gap: 15px; }
            .contest-input-group { flex-direction: column !important; }
            .contest-grid { grid-template-columns: 1fr; }
            .replies-container { margin-left: 20px; }
            .trash-result { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <nav>
        <ul>
            <li><a onclick="showPage('home')" id="menu-home">Trang Ch·ªß</a></li>
            <li><a onclick="showPage('activities')" id="menu-activities">Ho·∫°t ƒê·ªông</a></li>
            <li><a onclick="showPage('guide')" id="menu-guide">Tra C·ª©u</a></li>
            <li><a onclick="showPage('greenclass')" id="menu-greenclass">G√≥c Xanh</a></li>
            <li><a onclick="showPage('contest')" id="menu-contest">Thi ƒêua</a></li>
            <li><a onclick="showPage('discussion')" id="menu-discussion">Th·∫£o Lu·∫≠n</a></li>
        </ul>
    </nav>

    <div class="container">
        
        <div id="home" class="page-section">
            <h1>Green School - A2K41</h1>
            <p style="text-align: center;">Ng√¥i nh√† chung b·∫£o v·ªá m√¥i tr∆∞·ªùng.</p>
            <img src="https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?w=800&q=80" style="width: 100%; border-radius: 8px; display: block;">
            
            <div class="card" style="border-left: 5px solid #ffca28; margin-top: 20px;">
                <h3>üí° M√°ch nh·ªè b·∫°n nghe</h3>
                <p id="green-tip" style="font-size: 1.1rem; font-style: italic;">ƒêang t·∫£i...</p>
            </div>
        </div>

        <div id="activities" class="page-section">
            <h1>Ho·∫°t ƒê·ªông</h1>
            <div class="card"><h2>‚ôªÔ∏è "ƒê·ªïi gi·∫•y l·∫•y c√¢y"</h2><p>Mang gi·∫•y v·ª•n ƒë·∫øn ph√≤ng 101 ƒë·ªÉ nh·∫≠n sen ƒë√°.</p></div>
            <div class="card" style="border-left: 5px solid #039be5;">
                <h2>üì∞ Tin T·ª©c & K·∫øt N·ªëi</h2>
                <ul style="line-height: 1.8; list-style-type: none; padding-left: 0;">
                    <li style="margin-bottom: 15px;">
                        <a href="https://baodanang.vn/lan-toa-mo-hinh-truong-hoc-xanh-3309415.html" target="_blank" style="text-decoration: none; color: var(--primary-color); font-weight: bold; font-size: 1.1rem;">üå± B√°o ƒê√† N·∫µng: Tr∆∞·ªùng h·ªçc xanh</a>
                    </li>
                    <li>
                        <a href="https://www.facebook.com/tuoitrethptnguyenvancu?locale=vi_VN" target="_blank" style="text-decoration: none; color: #1877F2; font-weight: bold; font-size: 1.1rem;">üìò FB: Tu·ªïi tr·∫ª THPT Nguy·ªÖn VƒÉn C·ª´</a>
                    </li>
                </ul>
            </div>
        </div>

        <div id="guide" class="page-section">
            <h1>Tra C·ª©u Ph√¢n Lo·∫°i R√°c</h1>
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="trashSearchInput" placeholder="Nh·∫≠p t√™n r√°c (VD: V·ªè s·ªØa, Pin...)" onkeyup="filterTrash()">
            </div>
            <div id="trashContainer" class="trash-result"></div>
            <hr style="margin: 40px 0;">
            <h1>üó∫Ô∏è S∆° ƒê·ªì Th√πng R√°c</h1>
            <div class="card" style="text-align: center;">
                <img src="https://img.freepik.com/free-vector/school-map-template-hand-drawn-style_23-2147754663.jpg" style="max-width: 100%; border-radius: 8px;">
                <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">(S∆° ƒë·ªì minh h·ªça)</p>
            </div>
        </div>

        <div id="greenclass" class="page-section">
            <h1>G√≥c "L·ªõp H·ªçc Xanh"</h1>
            <p style="text-align: center; margin-bottom: 25px;">Th√†nh qu·∫£ x√¢y d·ª±ng kh√¥ng gian xanh c·ªßa t·∫≠p th·ªÉ A2K41 üåø</p>
            
            <div class="green-class-grid">
                <div class="green-class-item">
                    <img src="https://i.ibb.co/jkQ3vTy2/IMG-9914.jpg" class="green-class-img">
                    <div class="green-class-info"><strong>G√≥c H·ªçc T·∫≠p</strong><br>Trang tr√≠ c√¢y xanh t∆∞∆°i m√°t.</div>
                </div>
                <div class="green-class-item">
                    <img src="https://i.ibb.co/XZnjFfH3/IMG-4892.jpg" class="green-class-img">
                    <div class="green-class-info"><strong>S·ª©c S·ªëng M·ªõi</strong><br>Nh·ªØng m·∫ßm non ƒëang l·ªõn.</div>
                </div>
                <div class="green-class-item">
                    <img src="https://i.ibb.co/fdCBPMxJ/IMG-4893.jpg" class="green-class-img">
                    <div class="green-class-info"><strong>ChƒÉm S√≥c</strong><br>T∆∞·ªõi c√¢y m·ªói ng√†y.</div>
                </div>
                <div class="green-class-item">
                    <img src="https://i.ibb.co/Kp2MvZk9/IMG-9913.jpg" class="green-class-img">
                    <div class="green-class-info"><strong>S√°ng T·∫°o</strong><br>T·∫≠n d·ª•ng v·∫≠t li·ªáu t√°i ch·∫ø.</div>
                </div>
                <div class="green-class-item">
                    <img src="https://i.ibb.co/XfvRrv64/IMG-9911.jpg" class="green-class-img">
                    <div class="green-class-info"><strong>Th∆∞ Gi√£n</strong><br>G√≥c nh·ªè b√¨nh y√™n.</div>
                </div>
                <div class="green-class-item">
                    <img src="https://i.ibb.co/xSZJ4r1g/IMG-9912.jpg" class="green-class-img">
                    <div class="green-class-info"><strong>Th√¢n Thi·ªán</strong><br>M√¥i tr∆∞·ªùng h·ªçc t·∫≠p xanh.</div>
                </div>
                <div class="green-class-item">
                    <img src="https://i.ibb.co/xSL5VWcT/IMG-9906.jpg" class="green-class-img">
                    <div class="green-class-info"><strong>Lan T·ªèa</strong><br>M√†u xanh A2K41.</div>
                </div>
            </div>
        </div>

        <div id="contest" class="page-section">
            <h1>Kho·∫£nh Kh·∫Øc Xanh</h1>
            <div class="card" style="background: linear-gradient(135deg, #2e7d32, #81c784); color: white; text-align: center; margin-bottom: 20px;">
                <h3>‚è≥ Th·ªùi gian b√¨nh ch·ªçn c√≤n</h3>
                <div id="countdown" style="font-size: 1.8rem; font-weight: bold; font-family: monospace; margin: 10px 0;">Loading...</div>
                <p style="margin: 0; font-size: 0.9rem;">H√£y nhanh tay tham gia!</p>
            </div>

            <div id="contest-login-require" style="text-align: center; background: #fff3e0; padding: 20px; border-radius: 8px;">
                <p>üîí ƒêƒÉng nh·∫≠p ƒë·ªÉ tham gia</p>
                <button class="btn btn-google btn-login-trigger">G ƒêƒÉng nh·∫≠p b·∫±ng Google</button>
            </div>
            <div id="contest-form-container" class="card" style="display: none; background: #e8f5e9;">
                <h3>üì§ ƒêƒÉng b√†i d·ª± thi</h3>
                <form id="contestForm">
                    <div class="contest-input-group" style="display: flex; gap: 10px;">
                        <input type="text" id="inpContestName" placeholder="H·ªç t√™n" required style="flex: 2;">
                        <input type="text" id="inpContestClass" placeholder="L·ªõp" required style="flex: 1;">
                    </div>
                    <input type="url" id="inpContestLink" placeholder="Link (·∫¢nh/FB)..." required>
                    <input type="text" id="inpContestDesc" placeholder="M√¥ t·∫£..." required>
                    <button type="submit" class="btn" style="width: 100%;">ƒêƒÉng Ngay</button>
                </form>
            </div>
            
            <div id="contest-grid" class="contest-grid"></div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button id="btn-load-more" class="btn btn-outline" style="width: 100%; max-width: 200px; display: none;" onclick="loadMoreEntries()">Xem th√™m ‚¨áÔ∏è</button>
                <p id="loading-text" style="color: #888; display: none;">ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>
            <hr style="border: 0; border-top: 2px dashed #ccc; margin: 40px 0;">
            <h1>B·∫£ng V√†ng Thi ƒêua</h1>
            <div class="ranking-container">
                <div class="ranking-box">
                    <div class="ranking-title">üèÜ Top L·ªõp</div>
                    <table class="rank-table">
                        <thead><tr><th>#</th><th>L·ªõp</th><th>Tim</th></tr></thead>
                        <tbody id="class-ranking-body"><tr><td colspan="3">Ch∆∞a t·∫£i...</td></tr></tbody>
                    </table>
                </div>
                <div class="ranking-box">
                    <div class="ranking-title">üåü Top C√° Nh√¢n</div>
                    <table class="rank-table">
                        <thead><tr><th>#</th><th>T√™n</th><th>L·ªõp</th><th>Tim</th></tr></thead>
                        <tbody id="student-ranking-body"><tr><td colspan="4">Ch∆∞a t·∫£i...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="discussion" class="page-section">
            <h1>G√≥c Th·∫£o Lu·∫≠n</h1>
            <div id="discussion-login-require" style="text-align: center; padding: 30px; background: #fff3e0; border: 1px dashed orange; border-radius: 10px;">
                <h3>üîí ƒêƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n</h3>
                <button class="btn btn-google btn-login-trigger">G ƒêƒÉng nh·∫≠p b·∫±ng Google</button>
            </div>
            <div id="discussion-chat-container" style="display: none;">
                <div style="margin-bottom: 10px; overflow: hidden; display: flex; justify-content: space-between; align-items: center;">
                    <span class="user-display-name" style="font-weight: bold; color: var(--primary-color);">Xin ch√†o...</span>
                    <button class="btn-logout" style="background: #555; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.8rem;">Tho√°t</button>
                </div>
                <div class="card" style="background: #f1f8e9; padding: 15px;">
                    <form id="commentForm">
                        <textarea id="inpComment" rows="2" placeholder="Nh·∫≠p b√¨nh lu·∫≠n..." required></textarea>
                        <button type="submit" class="btn" style="margin-top: 5px;">G·ª≠i</button>
                    </form>
                </div>
            </div>
            <div id="comments-list" style="margin-top: 20px;"></div>
        </div>

    </div>

    <footer>
        <div class="qr-section">
            <strong>üì± Qu√©t m√£ QR ƒë·ªÉ truy c·∫≠p nhanh</strong>
            <div class="qr-box"><img id="page-qr" src="" width="120" height="120" alt="QR Code"></div>
        </div>
        <br>&copy; 2025 D·ª± √°n A2K41 - Powered by Firebase
    </footer>

    <div id="music-player" style="position: fixed; bottom: 20px; left: 20px; z-index: 9999; background: white; padding: 10px; border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; border: 2px solid var(--primary-color);">
        <div id="music-disc" style="animation: spin 3s linear infinite; display: none; font-size: 1.5rem;">üíø</div>
        <button id="btnMusic" onclick="toggleYoutubeMusic()" style="background: none; border: none; cursor: pointer; font-size: 1.2rem; font-weight: bold; color: var(--primary-color);">üîá B·∫≠t Nh·∫°c</button>
        <div style="position: absolute; width: 1px; height: 1px; overflow: hidden; opacity: 0; left: -9999px;"><div id="youtube-bg-player"></div></div>
    </div>
    <script>
        var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0]; firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        var player; var isPlaying = false; var musicDisc = document.getElementById("music-disc"); var btnMusic = document.getElementById("btnMusic");
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-bg-player', { height: '0', width: '0', videoId: 'hlWiI4xVXKY',
                playerVars: { 'autoplay': 1, 'loop': 1, 'playlist': 'hlWiI4xVXKY', 'controls': 0, 'showinfo': 0 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }
        function onPlayerReady(event) { event.target.playVideo(); }
        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) { isPlaying = true; musicDisc.style.display = "block"; btnMusic.innerText = "üîä T·∫Øt Nh·∫°c"; } 
            else { isPlaying = false; musicDisc.style.display = "none"; btnMusic.innerText = "üîá B·∫≠t Nh·∫°c"; }
        }
        function toggleYoutubeMusic() { if (player && player.getPlayerState) { if (isPlaying) player.pauseVideo(); else player.playVideo(); } }
    </script>
    <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, orderBy, query, serverTimestamp, doc, updateDoc, deleteDoc, arrayUnion, arrayRemove, limit, startAfter } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJ_XI_fq-yJC909jb9KLIKg3AfGdm6hNs",
            authDomain: "a2k41nvc-36b0b.firebaseapp.com",
            projectId: "a2k41nvc-36b0b",
            storageBucket: "a2k41nvc-36b0b.firebasestorage.app",
            messagingSenderId: "279516631226",
            appId: "1:279516631226:web:99012883ed7923ab5c3283",
            measurementId: "G-S4NTLYT5C9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let hasLoadedContest = false;
        let hasLoadedDiscussion = false;

        window.addEventListener('load', () => {
            const currentUrl = window.location.href;
            document.getElementById('page-qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(currentUrl)}`;
            renderTrashList(trashDatabase);
            const lastPage = localStorage.getItem('activePage') || 'home';
            showPage(lastPage);
            var tips = [ "T·∫Øt v√≤i n∆∞·ªõc khi ƒë√°nh rƒÉng.", "T√°i ch·∫ø gi·∫•y v·ª•n.", "H·∫°n ch·∫ø t√∫i nilon.", "R√∫t ph√≠ch c·∫Øm khi kh√¥ng d√πng.", "Tr·ªìng th√™m c√¢y xanh." ];
            document.getElementById("green-tip").innerText = '"' + tips[Math.floor(Math.random() * tips.length)] + '"';
        });

        window.showPage = function(pageId) {
            localStorage.setItem('activePage', pageId);
            var sections = document.getElementsByClassName('page-section');
            for (var i = 0; i < sections.length; i++) { sections[i].classList.remove('active'); }
            document.getElementById(pageId).classList.add('active');
            var menuLinks = document.querySelectorAll('nav ul li a');
            menuLinks.forEach(link => link.classList.remove('active-menu'));
            document.getElementById('menu-' + pageId).classList.add('active-menu');
            window.scrollTo(0, 0);

            if (pageId === 'contest' && !hasLoadedContest) {
                console.log("Lazy Load Thi ƒêua...");
                loadInitialContestData();
                setupRankingListener();
                hasLoadedContest = true;
            }

            if (pageId === 'discussion' && !hasLoadedDiscussion) {
                console.log("Lazy Load Th·∫£o Lu·∫≠n...");
                setupDiscussionListener();
                hasLoadedDiscussion = true;
            }
        }

        const loginButtons = document.querySelectorAll(".btn-login-trigger");
        const logoutButtons = document.querySelectorAll(".btn-logout");
        loginButtons.forEach(btn => btn.addEventListener("click", () => signInWithPopup(auth, provider).catch(err => alert("L·ªói: " + err.message))));
        logoutButtons.forEach(btn => btn.addEventListener("click", () => signOut(auth)));

        onAuthStateChanged(auth, (user) => {
            const contestLogin = document.getElementById("contest-login-require"); const contestForm = document.getElementById("contest-form-container");
            const discussLogin = document.getElementById("discussion-login-require"); const discussChat = document.getElementById("discussion-chat-container");
            const userNames = document.querySelectorAll(".user-display-name");
            if (user) {
                contestLogin.style.display = "none"; contestForm.style.display = "block";
                discussLogin.style.display = "none"; discussChat.style.display = "block";
                userNames.forEach(el => el.innerText = "üëã " + user.displayName);
            } else {
                contestLogin.style.display = "block"; contestForm.style.display = "none";
                discussLogin.style.display = "block"; discussChat.style.display = "none";
            }
        });

        const trashDatabase = [ { name: "V·ªè h·ªôp s·ªØa", type: "T√°i ch·∫ø", class: "bin-recycle", icon: "üßÉ" }, { name: "Chai nh·ª±a", type: "T√°i ch·∫ø", class: "bin-recycle", icon: "üçæ" }, { name: "Gi·∫•y v·ª•n", type: "T√°i ch·∫ø", class: "bin-recycle", icon: "üì∞" }, { name: "V·ªè chu·ªëi", type: "H·ªØu c∆°", class: "bin-organic", icon: "üçå" }, { name: "T√∫i nilon", type: "R√°c kh√°c", class: "bin-other", icon: "üõçÔ∏è" }, { name: "Pin", type: "Nguy h·∫°i", class: "bin-hazardous", icon: "üîã" } ];
        window.renderTrashList = (data) => {
            const container = document.getElementById('trashContainer'); container.innerHTML = "";
            data.forEach(item => { const div = document.createElement('div'); div.className = 'trash-item'; div.innerHTML = `<span class="trash-icon">${item.icon}</span><strong>${item.name}</strong><br><span class="bin-type ${item.class}">${item.type}</span>`; container.appendChild(div); });
        }
        window.filterTrash = () => { const keyword = document.getElementById('trashSearchInput').value.toLowerCase(); const filtered = trashDatabase.filter(item => item.name.toLowerCase().includes(keyword)); renderTrashList(filtered); }

        let lastVisibleEntry = null;
        const contestGrid = document.getElementById("contest-grid");
        const btnLoadMore = document.getElementById("btn-load-more");
        const loadingText = document.getElementById("loading-text");

        function renderContestItem(data, postId, currentUser) {
            const likes = data.likes || []; const likeCount = likes.length; let isLiked = (currentUser && likes.includes(currentUser.uid));
            let adminTools = (currentUser && data.uid === currentUser.uid) ? `<div class="contest-tools"><button class="tool-btn" onclick="editContestEntry('${postId}', '${data.description}', '${data.imageUrl}')">‚úèÔ∏è</button><button class="tool-btn" style="color:red" onclick="deleteContestEntry('${postId}')">üóëÔ∏è</button></div>` : "";
            const link = data.imageUrl.toLowerCase(); let isImage = ['.jpg','.jpeg','.png','.gif','.webp'].some(ext => link.includes(ext));
            let displayImage = isImage ? data.imageUrl : "https://cdn-icons-png.flaticon.com/512/2065/2065064.png"; let badgeText = isImage ? "·∫¢nh" : "Link"; let objectFit = isImage ? "cover" : "contain"; let padding = isImage ? "0" : "40px";
            const div = document.createElement("div"); div.className = "contest-item"; div.id = `contest-item-${postId}`;
            div.innerHTML = `${adminTools}<a href="${data.imageUrl}" target="_blank" class="contest-link-wrapper"><span class="link-badge">${badgeText}</span><img src="${displayImage}" class="contest-img" style="object-fit: ${objectFit}; padding: ${padding};"><div class="click-hint">Xem chi ti·∫øt</div></a><div class="contest-body"><div><div style="font-weight:bold; color:var(--primary-color)">${data.authorName}</div><div style="font-size:0.8rem; color:#666;">L·ªõp: ${data.className||'?'}</div><div style="font-size:0.9rem;">${data.description}</div></div><button class="btn-heart ${isLiked?'liked':''}" onclick="toggleLike('${postId}', ${isLiked})">${isLiked?'‚ù§Ô∏è':'ü§ç'} ${likeCount}</button></div>`;
            return div;
        }

        async function loadInitialContestData() {
            loadingText.style.display = 'block';
            const first = query(collection(db, "contest_entries"), orderBy("createdAt", "desc"), limit(10));
            const snaps = await getDocs(first);
            loadingText.style.display = 'none';
            if (snaps.empty) { contestGrid.innerHTML = "<p style='text-align:center;width:100%'>Ch∆∞a c√≥ b√†i d·ª± thi.</p>"; return; }
            lastVisibleEntry = snaps.docs[snaps.docs.length - 1]; const currentUser = auth.currentUser;
            snaps.forEach((doc) => { contestGrid.appendChild(renderContestItem(doc.data(), doc.id, currentUser)); });
            if(snaps.docs.length >= 10) btnLoadMore.style.display = 'inline-block';
        }

        window.loadMoreEntries = async () => {
            if(!lastVisibleEntry) return; btnLoadMore.disabled = true; btnLoadMore.innerText = "ƒêang t·∫£i...";
            const next = query(collection(db, "contest_entries"), orderBy("createdAt", "desc"), startAfter(lastVisibleEntry), limit(10));
            const snaps = await getDocs(next); btnLoadMore.disabled = false; btnLoadMore.innerText = "Xem th√™m ‚¨áÔ∏è";
            if (!snaps.empty) { lastVisibleEntry = snaps.docs[snaps.docs.length - 1]; const currentUser = auth.currentUser; snaps.forEach((doc) => { contestGrid.appendChild(renderContestItem(doc.data(), doc.id, currentUser)); }); if(snaps.docs.length < 10) btnLoadMore.style.display = 'none'; } else { btnLoadMore.style.display = 'none'; }
        }

        function setupRankingListener() {
            const classRankingBody = document.getElementById("class-ranking-body"); const studentRankingBody = document.getElementById("student-ranking-body");
            onSnapshot(query(collection(db, "contest_entries"), orderBy("createdAt", "desc"), limit(50)), (snapshot) => {
                let classScores = {}; let studentScores = [];
                snapshot.forEach((docSnap) => { const data = docSnap.data(); const count = data.likes?data.likes.length:0; const cl = data.className||"Kh√°c"; if(!classScores[cl]) classScores[cl]=0; classScores[cl]+=count; studentScores.push({name:data.authorName, class:cl, likes:count}); });
                const sClasses = Object.entries(classScores).sort((a,b)=>b[1]-a[1]).slice(0,5);
                classRankingBody.innerHTML = sClasses.length?"":"<tr><td colspan='3'>Ch∆∞a c√≥</td></tr>";
                sClasses.forEach((i,x)=>{ let ic=x==0?"ü•á":x==1?"ü•à":x==2?"ü•â":x+1; classRankingBody.innerHTML+=`<tr><td>${ic}</td><td><strong>${i[0]}</strong></td><td style="color:red;font-weight:bold">${i[1]}</td></tr>`; });
                const sStudents = studentScores.sort((a,b)=>b.likes-a.likes).slice(0,5);
                studentRankingBody.innerHTML = sStudents.length?"":"<tr><td colspan='4'>Ch∆∞a c√≥</td></tr>";
                sStudents.forEach((s,x)=>{ let ic=x==0?"ü•á":x==1?"ü•à":x==2?"ü•â":x+1; studentRankingBody.innerHTML+=`<tr><td>${ic}</td><td>${s.name}</td><td>${s.class}</td><td style="color:red;font-weight:bold">${s.likes}</td></tr>`; });
            });
        }

        document.getElementById("contestForm").addEventListener("submit", async (e) => { e.preventDefault(); const user = auth.currentUser; if (!user) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); const name = document.getElementById("inpContestName").value.trim(); const className = document.getElementById("inpContestClass").value.trim().toUpperCase(); const link = document.getElementById("inpContestLink").value; const desc = document.getElementById("inpContestDesc").value; try { await addDoc(collection(db, "contest_entries"), { authorName: name, className: className, uid: user.uid, imageUrl: link, description: desc, likes: [], createdAt: serverTimestamp() }); alert("ƒêƒÉng b√†i th√†nh c√¥ng!"); e.target.reset(); } catch (err) { console.error(err); alert("L·ªói khi ƒëƒÉng b√†i."); } });
        window.deleteContestEntry = async (pid) => { if(confirm("X√≥a b√†i n√†y?")) { try { await deleteDoc(doc(db, "contest_entries", pid)); document.getElementById(`contest-item-${pid}`).remove(); } catch(e) { alert("L·ªói: " + e.message); } } }
        window.editContestEntry = async (pid, desc, link) => { const nd = prompt("M√¥ t·∫£ m·ªõi:", desc); if(nd!==null) { let nl = link; if(confirm("ƒê·ªïi link?")) nl = prompt("Link m·ªõi:", link); if(nd||nl) { try{await updateDoc(doc(db,"contest_entries",pid),{description:nd, imageUrl:nl}); alert("ƒê√£ s·ª≠a!");}catch(e){alert("L·ªói:"+e.message);} } } }
        window.toggleLike = async (pid, liked) => { const user = auth.currentUser; if (!user) return alert("ƒêƒÉng nh·∫≠p ƒë·ªÉ th·∫£ tim!"); try { const ref = doc(db, "contest_entries", pid); if(liked) await updateDoc(ref, { likes: arrayRemove(user.uid) }); else await updateDoc(ref, { likes: arrayUnion(user.uid) }); alert("ƒê√£ ghi nh·∫≠n!"); } catch (e) { console.error(e); } };

        function setupDiscussionListener() {
            const cList = document.getElementById("comments-list"); cList.innerHTML = "ƒêang t·∫£i b√¨nh lu·∫≠n...";
            onSnapshot(query(collection(db, "comments"), orderBy("createdAt", "desc")), (snap) => {
                const allC = []; const curU = auth.currentUser; snap.forEach(d => { allC.push({ id: d.id, ...d.data() }) });
                const roots = allC.filter(c => !c.parentId); const reps = allC.filter(c => c.parentId);
                cList.innerHTML = ""; if(roots.length === 0) { cList.innerHTML = "Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o."; return; }
                roots.forEach(d => {
                    let ts = d.createdAt ? d.createdAt.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : "...";
                    let acts = (curU && d.uid === curU.uid) ? `<span class="action-link" onclick="editComment('${d.id}', '${d.text.replace(/'/g, "\\'")}')">S·ª≠a</span> | <span class="action-link action-delete" onclick="deleteComment('${d.id}')">X√≥a</span> | ` : "";
                    const myReps = reps.filter(r => r.parentId === d.id).sort((a,b)=>(a.createdAt?.seconds||0)-(b.createdAt?.seconds||0));
                    let rHTML = "";
                    myReps.forEach(r => {
                        let rts = r.createdAt ? r.createdAt.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : "...";
                        let rActs = (curU && r.uid === curU.uid) ? `- <span class="action-link" style="font-size:0.8rem" onclick="editComment('${r.id}', '${r.text.replace(/'/g, "\\'")}')">S·ª≠a</span> - <span class="action-link action-delete" style="font-size:0.8rem" onclick="deleteComment('${r.id}')">X√≥a</span>` : "";
                        rHTML += `<div class="reply-item"><img src="${r.photo||'https://via.placeholder.com/30'}" class="avatar"><div class="comment-content"><div style="font-weight:bold;font-size:0.9rem;color:var(--primary-color)">${r.name}</div><div class="comment-text" style="font-size:0.95rem;">${r.text}</div><div class="comment-actions" style="color:#999;">${rts} ${rActs}</div></div></div>`;
                    });
                    const div = document.createElement("div"); div.className = "comment-item";
                    div.innerHTML = `<div class="comment-main"><img src="${d.photo||'https://via.placeholder.com/40'}" class="avatar"><div class="comment-content"><div style="font-weight:bold; color:var(--primary-color)">${d.name}</div><div class="comment-text">${d.text}</div><div class="comment-actions"><span style="color:#999;">${ts}</span> ${acts} <span class="btn-reply-trigger" onclick="toggleReplyForm('${d.id}')">Tr·∫£ l·ªùi</span></div></div></div><div class="replies-container">${rHTML}</div><div id="reply-form-${d.id}" class="reply-form-container"><form onsubmit="sendReply(event, '${d.id}')"><textarea placeholder="Tr·∫£ l·ªùi..." required style="width:100%; margin-bottom:5px;"></textarea><button type="submit" class="btn btn-sm">G·ª≠i</button></form></div>`;
                    cList.appendChild(div);
                });
            });
        }

        document.getElementById("commentForm").addEventListener("submit", async (e) => { e.preventDefault(); const t = document.getElementById("inpComment").value; const u = auth.currentUser; if (u && t.trim()) { await addDoc(collection(db, "comments"), { name: u.displayName, photo: u.photoURL, uid: u.uid, text: t, parentId: null, createdAt: serverTimestamp() }); document.getElementById("inpComment").value = ""; } });
        window.sendReply = async (ev, pid) => { ev.preventDefault(); const f = ev.target; const t = f.querySelector('textarea').value; const u = auth.currentUser; if (u && t.trim()) { await addDoc(collection(db, "comments"), { name: u.displayName, photo: u.photoURL, uid: u.uid, text: t, parentId: pid, createdAt: serverTimestamp() }); f.querySelector('textarea').value = ""; f.parentElement.style.display = 'none'; } }
        window.toggleReplyForm = (cid) => { if (!auth.currentUser) return alert("ƒêƒÉng nh·∫≠p ƒë·ªÉ tr·∫£ l·ªùi!"); const f = document.getElementById(`reply-form-${cid}`); f.style.display = (f.style.display === 'none' || f.style.display === '') ? 'block' : 'none'; }
        window.deleteComment = async (cid) => { if(confirm("X√≥a?")) try{ await deleteDoc(doc(db,"comments",cid)); }catch(e){alert(e.message);} }
        window.editComment = async (cid, ot) => { const nt = prompt("S·ª≠a:", ot); if(nt!==null&&nt.trim()) try{ await updateDoc(doc(db,"comments",cid),{text:nt}); }catch(e){alert(e.message);} }
    </script>
</body>
</html>
