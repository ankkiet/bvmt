<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Green School - A2K41 Official</title>
    
    <meta name="theme-color" content="#2e7d32">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/2e7d32/ffffff.png?text=NVC+Green">
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE STYLES --- */
        :root { --primary: #2e7d32; --primary-dark: #1b5e20; --accent: #ffca28; --danger: #d32f2f; --bg: #f8f9fa; --text: #333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Nunito', sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; }

        /* --- NAVIGATION --- */
        nav.pc-nav { background: linear-gradient(to right, var(--primary), var(--primary-dark)); padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        nav.pc-nav ul { list-style: none; margin: 0; padding: 0; display: flex; justify-content: center; gap: 10px; }
        nav.pc-nav ul li a { color: white; font-weight: 700; text-transform: uppercase; padding: 10px 20px; border-radius: 30px; cursor: pointer; transition: 0.3s; }
        nav.pc-nav ul li a:hover, nav.pc-nav ul li a.active-menu { background: rgba(255,255,255,0.2); color: var(--accent); }
        nav.mobile-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eee; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .mobile-nav-inner { display: flex; height: 65px; justify-content: space-around; align-items: center; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #999; cursor: pointer; }
        .nav-item.active-menu { color: var(--primary); font-weight: 800; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 2px; }

        /* --- LAYOUT --- */
        .container { max-width: 1200px; width: 95%; margin: 25px auto; background: white; padding: 30px; border-radius: 20px; min-height: 80vh; }
        .page-section { display: none; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        h1 { font-family: 'Quicksand', sans-serif; color: var(--primary); text-align: center; border-bottom: 4px solid var(--accent); display: inline-block; position: relative; left: 50%; transform: translateX(-50%); margin-bottom: 30px; }
        .card { background: #fff; border: 1px solid #e0e0e0; border-radius: 16px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { background: var(--primary-dark); }
        .btn-danger { background: var(--danger); }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; }

        /* --- GALLERY & ADMIN CONTROLS --- */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .gallery-item { position: relative; border-radius: 12px; overflow: hidden; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: 0.3s; }
        .gallery-item:hover { transform: translateY(-3px); }
        .gallery-img-container { width: 100%; aspect-ratio: 1/1; overflow: hidden; background: #eee; }
        .gallery-img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-info { padding: 10px; }
        .gallery-title { font-size: 0.9rem; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* ADMIN POWER BUTTONS */
        .owner-controls { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; z-index: 5; }
        .ctrl-btn { width: 30px; height: 30px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; background: rgba(255,255,255,0.9); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .ctrl-btn.edit { color: #1976d2; }
        .ctrl-btn.del { color: #d32f2f; }

        /* --- LIGHTBOX (FULL SCREEN & REACTIONS) --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; }
        .lb-container { display: flex; flex-direction: column; height: 100%; width: 100%; max-width: 600px; margin: 0 auto; background: white; position: relative; }
        
        /* IMMERSIVE MODE STYLES */
        .lb-container.immersive .lb-details, 
        .lb-container.immersive .lb-close-btn { display: none !important; }
        .lb-container.immersive .lb-image-area { height: 100vh; background: black; }
        .lb-container.immersive .lb-image-area img { object-fit: contain; }

        .lb-image-area { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; }
        .lb-image-area img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s; }
        .lb-close-btn { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.5); color: white; width: 35px; height: 35px; border-radius: 50%; border: none; cursor: pointer; font-size: 1.2rem; z-index: 100; }
        
        .lb-details { background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 15px; max-height: 50vh; display: flex; flex-direction: column; transition: 0.3s; }
        .lb-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .lb-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .lb-actions { display: flex; gap: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .lb-action-item { background: none; border: none; cursor: pointer; font-size: 0.9rem; color: #555; display: flex; gap: 5px; align-items: center; }
        .lb-action-item.liked { color: #e53935; }

        /* REACTIONS REPLACING COMMENTS */
        .lb-reaction-list { flex: 1; overflow-y: auto; margin-bottom: 10px; }
        .lb-reaction-item { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .lb-reaction-bubble { background: #f0f2f5; padding: 6px 12px; border-radius: 15px; font-size: 0.9rem; }
        
        .lb-reaction-presets { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; scrollbar-width: none; }
        .preset-chip { padding: 8px 15px; background: #e8f5e9; color: var(--primary); border: 1px solid var(--primary); border-radius: 20px; font-size: 0.85rem; white-space: nowrap; cursor: pointer; font-weight: bold; }
        .preset-chip:active { transform: scale(0.95); background: var(--primary); color: white; }

        /* --- EXTRAS --- */
        .ai-fab, .music-fab { position: fixed; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2000; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .music-fab { bottom: 85px; right: 15px; background: white; border: 2px solid var(--primary); }
        .ai-fab { bottom: 145px; right: 15px; background: linear-gradient(135deg, #6200ea, #b388ff); color: white; }
        .ai-chat-window { position: fixed; bottom: 200px; right: 15px; width: 300px; height: 400px; background: white; border-radius: 15px; display: none; flex-direction: column; z-index: 2001; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .ai-body { flex: 1; overflow-y: auto; padding: 10px; background: #f5f5f5; }
        .ai-msg { padding: 8px 12px; border-radius: 10px; margin-bottom: 5px; font-size: 0.9rem; width: fit-content; max-width: 80%; }
        .ai-msg.bot { background: white; border: 1px solid #ddd; }
        .ai-msg.user { background: #6200ea; color: white; align-self: flex-end; }

        @media (min-width: 768px) {
            .container { padding: 40px; }
            nav.pc-nav { display: block; }
            nav.mobile-nav { display: none; }
            .lb-container { max-width: 900px; height: 85vh; border-radius: 10px; flex-direction: row; margin: 40px auto; overflow: hidden; }
            .lb-image-area { width: 65%; }
            .lb-details { width: 35%; max-height: none; margin: 0; border-radius: 0; }
            .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
        }
        @media (max-width: 767px) {
            nav.pc-nav { display: none; }
            nav.mobile-nav { display: block; }
            .container { padding: 20px 15px 100px; margin: 0; width: 100%; border-radius: 0; box-shadow: none; }
        }
    </style>
</head>
<body>

    <!-- OVERLAY B·∫¢O TR√å -->
    <div id="maintenance-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:99999; flex-direction:column; justify-content:center; align-items:center;">
        <h1>‚ö†Ô∏è B·∫£o Tr√¨</h1>
        <button class="btn" onclick="checkAdminLogin()">Admin Login</button>
    </div>

    <!-- AI & MUSIC -->
    <div class="ai-fab" onclick="toggleAIChat()"><i class="fas fa-robot"></i></div>
    <div class="ai-chat-window" id="ai-window">
        <div style="background:#6200ea; color:white; padding:10px; font-weight:bold; display:flex; justify-content:space-between;">
            <span>Green Bot (AI 2.0)</span> <span onclick="toggleAIChat()" style="cursor:pointer">‚úï</span>
        </div>
        <div class="ai-body" id="ai-messages"><div class="ai-msg bot">Ch√†o b·∫°n! T·ªõ c√≥ th·ªÉ gi√∫p g√¨ v·ªÅ web NVC Green kh√¥ng?</div></div>
        <form onsubmit="sendMessageToAI(event)" style="padding:10px; display:flex; gap:5px; background:white;">
            <input id="ai-input" required placeholder="Nh·∫≠p tin nh·∫Øn...">
            <button class="btn btn-sm">G·ª≠i</button>
        </form>
    </div>

    <div class="music-fab" onclick="toggleMusic()"><i class="fas fa-compact-disc" id="music-icon"></i></div>
    <div id="player" style="display:none;"></div>

    <!-- NAV PC -->
    <nav class="pc-nav">
        <ul>
            <li><a onclick="showPage('home')" id="menu-pc-home">Trang Ch·ªß</a></li>
            <li><a onclick="showPage('greenclass')" id="menu-pc-greenclass">G√≥c Xanh</a></li>
            <li><a onclick="showPage('contest')" id="menu-pc-contest">Thi ƒêua</a></li>
            <li><a onclick="showPage('archive')" id="menu-pc-archive">L∆∞u Tr·ªØ</a></li>
            <li><a onclick="showPage('profile')" id="menu-pc-profile">T√†i Kho·∫£n</a></li>
            <li><a onclick="showPage('admin')" id="menu-pc-admin" style="display:none; color:#ff8a80">ADMIN</a></li>
        </ul>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="container">
        
        <!-- HOME SECTION -->
        <div id="home" class="page-section">
            <div style="text-align: center;">
                <img src="https://images.pexels.com/photos/1591447/pexels-photo-1591447.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" style="width:100%; border-radius:15px; margin-bottom:20px;">
                <h1>A2K41 - Green School</h1>
                <!-- N√∫t ƒëƒÉng nh·∫≠p trang ch·ªß (Fixed) -->
                <div id="home-login-area" style="text-align:center; margin-top:20px;">
                    <button class="btn" style="border-radius:50px; padding:15px 40px; font-size:1.2rem;" onclick="signInWithPopup(auth, provider)">
                        <i class="fas fa-sign-in-alt"></i> ƒêƒÉng Nh·∫≠p Ngay
                    </button>
                </div>
            </div>
        </div>

        <!-- GREEN CLASS (G√ìC XANH) -->
        <div id="greenclass" class="page-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>üåø G√≥c Xanh</h2>
                <button class="btn" onclick="checkLoginAndUpload('gallery')"><i class="fas fa-camera"></i> ƒêƒÉng ·∫¢nh</button>
            </div>
            <div id="gallery-grid" class="gallery-grid"></div>
        </div>

        <!-- CONTEST (THI ƒêUA) -->
        <div id="contest" class="page-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>üèÜ Thi ƒêua</h2>
                <button class="btn" onclick="checkLoginAndUpload('contest')"><i class="fas fa-upload"></i> B√°o C√°o</button>
            </div>
            <div id="contest-grid" class="gallery-grid"></div>
        </div>

        <!-- ARCHIVE (L∆ØU TR·ªÆ) -->
        <div id="archive" class="page-section">
            <h2>üóÑÔ∏è Kho L∆∞u Tr·ªØ</h2>
            <div class="archive-controls">
                <div class="archive-tab active" onclick="switchArchiveTab('gallery')" id="tab-ar-gallery">G√≥c Xanh</div>
                <div class="archive-tab" onclick="switchArchiveTab('contest')" id="tab-ar-contest">Thi ƒêua</div>
            </div>
            <select id="archive-season-select" onchange="loadArchiveGrid()" style="margin-bottom:15px"><option value="ALL">T·∫•t c·∫£ ƒë·ª£t</option></select>
            <div id="archive-grid" class="gallery-grid"></div>
        </div>

        <!-- PROFILE -->
        <div id="profile" class="page-section">
            <h1>üë§ H·ªì S∆°</h1>
            <div id="profile-out" style="text-align:center; padding:40px;">
                <p>B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.</p>
                <!-- N√∫t ƒëƒÉng nh·∫≠p profile (Fixed) -->
                <button class="btn" onclick="signInWithPopup(auth, provider)"><i class="fab fa-google"></i> ƒêƒÉng nh·∫≠p Google</button>
            </div>
            <div id="profile-in" style="display:none;">
                <div class="card" style="text-align:center;">
                    <img id="p-avatar" src="" style="width:100px; height:100px; border-radius:50%; margin-bottom:10px;">
                    <h3 id="p-name">T√™n User</h3>
                    <p id="p-email">email@gmail.com</p>
                    <button class="btn btn-danger" onclick="handleLogout()" style="margin-top:20px;">ƒêƒÉng Xu·∫•t</button>
                </div>
            </div>
        </div>

        <!-- ADMIN PANEL -->
        <div id="admin" class="page-section">
            <h1>üõ† Admin Panel</h1>
            <div class="card">
                <h3>Qu·∫£n l√Ω h·ªá th·ªëng</h3>
                <label><input type="checkbox" id="cfg-maintenance" onchange="updateMainConfig()"> B·∫£o tr√¨ to√†n trang</label>
            </div>
            <div class="card">
                <h3>Danh s√°ch th√†nh vi√™n</h3>
                <div style="overflow-x:auto"><table class="admin-table"><tbody id="user-table-body"></tbody></table></div>
                <button class="btn btn-sm" onclick="loadAdminData()">L√†m m·ªõi</button>
            </div>
        </div>

    </div>

    <!-- MOBILE NAV -->
    <nav class="mobile-nav">
        <div class="mobile-nav-inner">
            <a onclick="showPage('home')" id="mob-home" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
            <a onclick="showPage('greenclass')" id="mob-greenclass" class="nav-item"><i class="fas fa-leaf"></i><span>Xanh</span></a>
            <a onclick="showPage('contest')" id="mob-contest" class="nav-item"><i class="fas fa-trophy"></i><span>Thiƒêua</span></a>
            <a onclick="showPage('archive')" id="mob-archive" class="nav-item"><i class="fas fa-box"></i><span>L∆∞u</span></a>
            <a onclick="showPage('profile')" id="mob-profile" class="nav-item"><i class="fas fa-user"></i><span>T√¥i</span></a>
            <a onclick="showPage('admin')" id="mob-admin" class="nav-item" style="display:none; color:red"><i class="fas fa-cogs"></i><span>Admin</span></a>
        </div>
    </nav>

    <!-- LIGHTBOX V·ªöI "C·∫¢M X√öC NHANH" -->
    <div id="lightbox" class="modal" onclick="if(event.target==this) closeLightbox()">
        <div class="lb-container" id="lb-main-container">
            <button class="lb-close-btn" onclick="closeLightbox()">‚úï</button>
            
            <!-- ·∫¢nh (B·∫•m v√†o ƒë·ªÉ Full Screen) -->
            <div class="lb-image-area" onclick="toggleImmersiveMode()">
                <img id="lb-img">
            </div>

            <!-- Ph·∫ßn th√¥ng tin (s·∫Ω ·∫©n ƒëi khi Full Screen) -->
            <div class="lb-details">
                <div class="lb-header">
                    <img id="lb-author-avatar" class="lb-avatar">
                    <div style="flex:1">
                        <div id="lb-author-name" style="font-weight:bold;">Name</div>
                        <div id="lb-desc" style="font-size:0.9rem; color:#555;">M√¥ t·∫£ ·∫£nh...</div>
                    </div>
                </div>

                <div class="lb-actions">
                    <button id="lb-like" class="lb-action-item" onclick="handleLike()"><i class="fas fa-heart"></i> <span id="lb-like-count">0</span></button>
                    <button class="lb-action-item"><i class="fas fa-download"></i></button>
                </div>

                <!-- Khu v·ª±c hi·ªÉn th·ªã c·∫£m x√∫c ƒë√£ th·∫£ -->
                <div class="lb-comments-wrapper" id="lb-cmt-list"></div>

                <!-- Khu v·ª±c CH·ªåN C·∫¢M X√öC (Kh√¥ng c√≥ √¥ nh·∫≠p) -->
                <div class="lb-reaction-presets">
                    <div class="preset-chip" onclick="postReaction('Tuy·ªát v·ªùi üòç')">Tuy·ªát v·ªùi üòç</div>
                    <div class="preset-chip" onclick="postReaction('C·ªë l√™n nh√© üí™')">C·ªë l√™n nh√© üí™</div>
                    <div class="preset-chip" onclick="postReaction('S√°ng t·∫°o üåü')">S√°ng t·∫°o üåü</div>
                    <div class="preset-chip" onclick="postReaction('ƒê·∫πp l·∫Øm üì∏')">ƒê·∫πp l·∫Øm üì∏</div>
                    <div class="preset-chip" onclick="postReaction('C·∫ßn c·ªë g·∫Øng üõ†Ô∏è')">C·∫ßn c·ªë g·∫Øng üõ†Ô∏è</div>
                    <div class="preset-chip" onclick="postReaction('Xanh s·∫°ch ƒë·∫πp üå±')">Xanh s·∫°ch ƒë·∫πp üå±</div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp, doc, setDoc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. CONFIG
        const firebaseConfig = { apiKey: "AIzaSyCJ_XI_fq-yJC909jb9KLIKg3AfGdm6hNs", authDomain: "a2k41nvc-36b0b.firebaseapp.com", projectId: "a2k41nvc-36b0b", storageBucket: "a2k41nvc-36b0b.firebasestorage.app", messagingSenderId: "279516631226", appId: "1:279516631226:web:99012883ed7923ab5c3283" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // ADMIN EMAILS
        const ADMIN_EMAILS = ["kiet0905478167@gmail.com", "anhkiet119209@gmail.com"];
        const CLOUD_NAME = "dekxvneap"; const UPLOAD_PRESET = "a2k41nvc_upload";
        let geminiKey = "AIzaSyAnOwbqmpQcOu_ERINF4nSfEL4ZW95fiGc";

        let currentUser = null, currentCollection = 'gallery', currentImgId = null, activeArchiveTab = 'gallery';
        const isAdmin = (email) => ADMIN_EMAILS.includes(email);

        // --- EXPOSE TO WINDOW ---
        window.signInWithPopup = signInWithPopup;
        window.auth = auth;
        window.provider = provider;

        // 2. AUTHENTICATION
        onAuthStateChanged(auth, async(u) => {
            if (u) {
                currentUser = { uid: u.uid, email: u.email, displayName: u.displayName, photoURL: u.photoURL };
                document.getElementById('profile-in').style.display = 'block';
                document.getElementById('profile-out').style.display = 'none';
                document.getElementById('home-login-area').style.display = 'none'; // ·∫®n n√∫t login ·ªü Home
                document.getElementById('p-avatar').src = u.photoURL;
                document.getElementById('p-name').innerText = u.displayName;
                document.getElementById('p-email').innerText = u.email;
                if(isAdmin(u.email)) {
                    document.getElementById('menu-pc-admin').style.display = 'block';
                    document.getElementById('mob-admin').style.display = 'flex';
                }
            } else {
                currentUser = null;
                document.getElementById('profile-in').style.display = 'none';
                document.getElementById('profile-out').style.display = 'block';
                document.getElementById('home-login-area').style.display = 'block';
                document.getElementById('menu-pc-admin').style.display = 'none';
                document.getElementById('mob-admin').style.display = 'none';
            }
        });

        window.handleLogout = () => signOut(auth).then(() => location.reload());

        // 3. ADMIN POWER: RENDER GRID
        // H√†m n√†y d√πng chung cho G√≥c Xanh, Thi ƒêua v√† L∆∞u Tr·ªØ
        // ƒê√£ th√™m Logic: N·∫øu l√† Admin -> Hi·ªán n√∫t S·ª≠a/X√≥a cho M·ªåI B√ÄI
        function renderGrid(col, elId) {
            onSnapshot(query(collection(db, col), where("archived", "!=", true)), (snap) => {
                const g = document.getElementById(elId);
                g.innerHTML = "";
                const docs = [];
                snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
                docs.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));

                docs.forEach(d => {
                    let ctrls = "";
                    // SUPER ADMIN CHECK: Cho ph√©p s·ª≠a/x√≥a n·∫øu l√† ch·ªß b√†i HO·∫∂C l√† Admin
                    if (currentUser && (currentUser.uid === d.uid || isAdmin(currentUser.email))) {
                        ctrls = `
                        <div class="owner-controls">
                            <button class="ctrl-btn edit" onclick="event.stopPropagation();editPost('${col}','${d.id}','${d.desc}')"><i class="fas fa-pen"></i></button>
                            <button class="ctrl-btn del" onclick="event.stopPropagation();deletePost('${col}','${d.id}')"><i class="fas fa-trash"></i></button>
                        </div>`;
                    }
                    g.innerHTML += `
                    <div class="gallery-item" onclick="openLightbox('${col}','${d.id}')">
                        ${ctrls}
                        <div class="gallery-img-container"><img src="${d.url}" class="gallery-img"></div>
                        <div class="gallery-info">
                            <div class="gallery-title">${d.desc}</div>
                            <div style="font-size:0.8rem; color:#666; display:flex; justify-content:space-between">
                                <span>${d.authorName}</span>
                                <span><i class="fas fa-heart"></i> ${d.likes?d.likes.length:0}</span>
                            </div>
                        </div>
                    </div>`;
                });
            });
        }

        // Render ban ƒë·∫ßu
        renderGrid('gallery', 'gallery-grid');
        renderGrid('contest', 'contest-grid');

        // 4. ARCHIVE GRID (C≈©ng √°p d·ª•ng quy·ªÅn Admin)
        window.loadArchiveGrid = async () => {
            const label = document.getElementById('archive-season-select').value;
            const g = document.getElementById('archive-grid');
            g.innerHTML = "Loading...";
            
            let q;
            if(label === 'ALL') q = query(collection(db, activeArchiveTab), where("archived", "==", true));
            else q = query(collection(db, activeArchiveTab), where("archived", "==", true), where("archiveLabel", "==", label));
            
            const s = await getDocs(q);
            g.innerHTML = "";
            s.forEach(d => {
                const da = d.data();
                let ctrls = "";
                // ADMIN C√ì QUY·ªÄN S·ª¨A C·∫¢ TRONG KHO L∆ØU TR·ªÆ
                if (currentUser && (currentUser.uid === da.uid || isAdmin(currentUser.email))) {
                    ctrls = `
                    <div class="owner-controls">
                        <button class="ctrl-btn edit" onclick="event.stopPropagation();editPost('${activeArchiveTab}','${d.id}','${da.desc}')"><i class="fas fa-pen"></i></button>
                        <button class="ctrl-btn del" onclick="event.stopPropagation();deletePost('${activeArchiveTab}','${d.id}')"><i class="fas fa-trash"></i></button>
                    </div>`;
                }
                g.innerHTML += `
                <div class="gallery-item" onclick="openLightbox('${activeArchiveTab}','${d.id}')">
                    ${ctrls}
                    <div class="gallery-img-container"><img src="${da.url}" class="gallery-img"></div>
                    <div class="gallery-info"><div class="gallery-title">${da.desc}</div></div>
                </div>`;
            });
        }

        // 5. LIGHTBOX & FULL SCREEN LOGIC
        window.openLightbox = async (c, i) => {
            currentImgId = i; currentCollection = c;
            document.getElementById('lightbox').style.display = 'block';
            document.getElementById('lb-main-container').classList.remove('immersive'); // Reset mode
            
            const s = await getDoc(doc(db, c, i));
            const d = s.data();
            
            document.getElementById('lb-img').src = d.url;
            document.getElementById('lb-author-avatar').src = d.authorAvatar || 'https://placehold.co/50';
            document.getElementById('lb-author-name').innerText = d.authorName;
            document.getElementById('lb-desc').innerText = d.desc;
            document.getElementById('lb-like-count').innerText = d.likes ? d.likes.length : 0;
            
            const btn = document.getElementById('lb-like');
            if(currentUser && d.likes?.includes(currentUser.uid)) {
                btn.classList.add('liked'); btn.style.color='red';
            } else {
                btn.classList.remove('liked'); btn.style.color='#555';
            }

            renderComments(d.comments || []);
        }

        window.closeLightbox = () => document.getElementById('lightbox').style.display = 'none';

        // CH·∫æ ƒê·ªò IMMERSIVE (FULL SCREEN ·∫¢NH)
        window.toggleImmersiveMode = () => {
            const container = document.getElementById('lb-main-container');
            container.classList.toggle('immersive');
        }

        // TH·∫¢ TIM (B·∫ÆT BU·ªòC LOGIN)
        window.handleLike = async () => {
            if(!currentUser) return alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·∫£ tim! ‚ù§Ô∏è");
            const ref = doc(db, currentCollection, currentImgId);
            const s = await getDoc(ref);
            const likes = s.data().likes || [];
            if(likes.includes(currentUser.uid)) {
                await updateDoc(ref, { likes: arrayRemove(currentUser.uid) });
                document.getElementById('lb-like').style.color='#555';
                document.getElementById('lb-like-count').innerText = likes.length - 1;
            } else {
                await updateDoc(ref, { likes: arrayUnion(currentUser.uid) });
                document.getElementById('lb-like').style.color='red';
                document.getElementById('lb-like-count').innerText = likes.length + 1;
            }
        }

        // TH·∫¢ C·∫¢M X√öC (REACTION)
        window.postReaction = async (text) => {
            if(!currentUser) return alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ t∆∞∆°ng t√°c! üí¨");
            await updateDoc(doc(db, currentCollection, currentImgId), {
                comments: arrayUnion({
                    uid: currentUser.uid,
                    name: currentUser.displayName,
                    avatar: currentUser.photoURL,
                    text: text,
                    time: Date.now()
                })
            });
            const s = await getDoc(doc(db, currentCollection, currentImgId));
            renderComments(s.data().comments);
        }

        function renderComments(arr) {
            const list = document.getElementById('lb-cmt-list');
            list.innerHTML = "";
            if(!arr || arr.length === 0) {
                list.innerHTML = "<div style='text-align:center; color:#999; font-size:0.8rem;'>Ch∆∞a c√≥ c·∫£m x√∫c n√†o.</div>";
                return;
            }
            arr.forEach(c => {
                list.innerHTML += `
                <div class="lb-reaction-item">
                    <img src="${c.avatar}" style="width:25px; height:25px; border-radius:50%;">
                    <div class="lb-reaction-bubble">
                        <strong>${c.name}</strong>: <span style="color:var(--primary); font-weight:bold;">${c.text}</span>
                    </div>
                </div>`;
            });
        }

        // 6. ADMIN ACTIONS
        window.deletePost = async (c, i) => {
            if(confirm("Admin: B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i n√†y vƒ©nh vi·ªÖn?")) {
                await deleteDoc(doc(db, c, i));
                alert("ƒê√£ x√≥a!");
                if(document.getElementById('lightbox').style.display === 'block') closeLightbox();
                if(c === activeArchiveTab) loadArchiveGrid(); // Reload archive if needed
            }
        }

        window.editPost = async (c, i, oldDesc) => {
            const newDesc = prompt("Admin Edit: Nh·∫≠p m√¥ t·∫£ m·ªõi:", oldDesc);
            if(newDesc) {
                await updateDoc(doc(db, c, i), { desc: newDesc });
                alert("ƒê√£ c·∫≠p nh·∫≠t!");
                if(document.getElementById('lightbox').style.display === 'block') {
                    document.getElementById('lb-desc').innerText = newDesc;
                }
                if(c === activeArchiveTab) loadArchiveGrid();
            }
        }

        // 7. NAVIGATION & UTILS
        window.showPage = (id) => {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            sessionStorage.setItem('page', id);
            
            // Menu highlight logic
            document.querySelectorAll('nav.pc-nav a, .nav-item').forEach(a => a.classList.remove('active-menu'));
            if(document.getElementById('menu-pc-'+id)) document.getElementById('menu-pc-'+id).classList.add('active-menu');
            if(document.getElementById('mob-'+id)) document.getElementById('mob-'+id).classList.add('active-menu');

            if(id === 'archive') { loadArchiveSeasons(); window.loadArchiveGrid(); }
        }
        
        // Load page from session
        showPage(sessionStorage.getItem('page') || 'home');

        window.switchArchiveTab = (t) => {
            activeArchiveTab = t;
            document.querySelectorAll('.archive-tab').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-ar-'+t).classList.add('active');
            loadArchiveSeasons();
            loadArchiveGrid();
        }

        window.loadArchiveSeasons = async () => {
            const s = document.getElementById('archive-season-select');
            s.innerHTML = '<option value="ALL">üìÇ T·∫•t c·∫£ ·∫£nh l∆∞u tr·ªØ</option>';
            const q = query(collection(db, "archives_meta"), where("collection", "==", activeArchiveTab), orderBy("archivedAt", "desc"));
            const sn = await getDocs(q);
            sn.forEach(d => s.innerHTML += `<option value="${d.data().label}">${d.data().label}</option>`);
        }

        // UPLOAD & AI VISION
        window.checkLoginAndUpload = (c) => {
            if(!currentUser) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!");
            currentCollection = c;
            document.getElementById('file-input').click();
        }

        window.executeUpload = async (input) => {
            const file = input.files[0];
            if(!file) return;
            
            // AI PROMPT UPGRADED
            const useAI = confirm("ü§ñ D√πng AI ph√¢n t√≠ch ·∫£nh m√¥i tr∆∞·ªùng kh√¥ng?");
            let desc = "";
            
            if(useAI) {
                document.getElementById('upload-loading-text').innerText = "AI ƒëang soi ·∫£nh...";
                document.getElementById('upload-overlay').style.display = 'flex';
                try {
                    const b64 = await new Promise((r) => {
                        const reader = new FileReader();
                        reader.onload = () => r(reader.result.split(',')[1]);
                        reader.readAsDataURL(file);
                    });
                    
                    // G·ªçi AI v·ªõi Prompt chuy√™n s√¢u
                    desc = await callGeminiAPI("H√£y ƒë√≥ng vai gi√°m kh·∫£o cu·ªôc thi Green School. M√¥ t·∫£ b·ª©c ·∫£nh n√†y, ch·ªâ ra h√†nh ƒë·ªông b·∫£o v·ªá m√¥i tr∆∞·ªùng, ch·∫•m ƒëi·ªÉm √Ω th·ª©c (tr√™n thang 10) v√† ƒë∆∞a ra l·ªùi khen ng·ª£i ng·∫Øn g·ªçn:", b64);
                } catch(e) {
                    alert("AI qu√° t·∫£i, vui l√≤ng t·ª± nh·∫≠p m√¥ t·∫£.");
                    desc = prompt("Nh·∫≠p m√¥ t·∫£ ·∫£nh:");
                }
            } else {
                desc = prompt("Nh·∫≠p m√¥ t·∫£ ·∫£nh:");
            }

            if(!desc) { document.getElementById('upload-overlay').style.display='none'; return; }

            // Upload Cloudinary
            document.getElementById('upload-loading-text').innerText = "ƒêang t·∫£i ·∫£nh l√™n...";
            document.getElementById('upload-overlay').style.display = 'flex';
            
            const fd = new FormData();
            fd.append('file', file);
            fd.append('upload_preset', UPLOAD_PRESET);
            
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method:'POST', body:fd });
                const data = await res.json();
                
                await addDoc(collection(db, currentCollection), {
                    url: data.secure_url,
                    desc: desc,
                    uid: currentUser.uid,
                    authorName: currentUser.displayName,
                    authorAvatar: currentUser.photoURL,
                    createdAt: serverTimestamp(),
                    likes: [],
                    comments: []
                });
                alert("ƒêƒÉng th√†nh c√¥ng!");
            } catch(e) {
                alert("L·ªói: " + e.message);
            }
            document.getElementById('upload-overlay').style.display = 'none';
            input.value = "";
        }

        // GEMINI API FUNCTION (REUSED V43)
        async function callGeminiAPI(prompt, imageBase64) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`;
            const body = {
                contents: [{ parts: [{ text: prompt }] }]
            };
            if(imageBase64) body.contents[0].parts.push({ inline_data: { mime_type: "image/jpeg", data: imageBase64 }});
            
            const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        }

    </script>
</body>
</html>
